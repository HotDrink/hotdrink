# Umbrella Makefile.

MAKEDIR := make
include $(MAKEDIR)/Makefile.common

PRIMARY := lib
BUILDDIR := build

##################################################
# self configuration (do not touch)

export MAKEDIR
export BUILDDIR

##################################################
# targets

.PHONY : all debug release doc test lint

all :
	@$(call defer,$(MAKEDIR)/Makefile.$(PRIMARY))

debug :
	@$(call defer,$(MAKEDIR)/Makefile.$(PRIMARY))

raw :
	@$(call defer,$(MAKEDIR)/Makefile.$(PRIMARY))

release :
	@$(call defer,$(MAKEDIR)/Makefile.$(PRIMARY))

doc :
	@$(call defer,$(MAKEDIR)/Makefile.$(PRIMARY))

test :
	@$(MAKE) -f $(MAKEDIR)/Makefile.test

lint :
	@$(call defer,$(MAKEDIR)/Makefile.$(PRIMARY))


##################################################
# publishing

.PHONY : publish pubdebug pubrelease pubtut clean-pubtut

PUBHOST := example.com
PUBPATH := path/to/root
PUBTUTPATH := $(PUBPATH)/tutorial

PUBFILES := $(shell find tutorial -name '.*.swp' -prune -o -type f -print)
PUBLAST := build/lastpublished

publish : pubdebug pubrelease pubtut

pubdebug : debug
	scp hotdrink.js $(PUBHOST):$(PUBPATH)/hotdrink-debug.js

pubrelease : release
	gunzip -f hotdrink.js.gz
	scp hotdrink.js $(PUBHOST):$(PUBPATH)/hotdrink.js

pubtut : $(PUBLAST)

$(PUBLAST) : $(PUBFILES)
	@-ssh $(PUBHOST) 'mkdir $(PUBTUTPATH)' 2>/dev/null
	@scp -r $? $(PUBHOST):$(PUBTUTPATH)
	@touch $@

clean-pubtut :
	@-ssh $(PUBHOST) 'rm -rf $(PUBTUTPATH)' 2>/dev/null
	@rm -f $(PUBLAST)

##################################################
# cleaning

.PHONY : clean clean-obj clean-exe clean-doc clean-test

clean : clean-exe
	@$(MAKE) -f $(MAKEDIR)/Makefile.test clean-exe
	-rm -rf $(BUILDDIR)

clean-obj :
	@$(call defer,$(MAKEDIR)/Makefile.$(PRIMARY))

clean-exe :
	@$(call defer,$(MAKEDIR)/Makefile.$(PRIMARY))

clean-doc :
	@$(call defer,$(MAKEDIR)/Makefile.$(PRIMARY))

clean-test :
	@$(MAKE) -f $(MAKEDIR)/Makefile.test clean

