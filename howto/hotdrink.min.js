var hd;!function(t){var e;!function(t){var e;!function(t){function e(t){return t.slice(0)}function n(t,e){return-1!=t.indexOf(e)}function r(t,e){return-1==t.indexOf(e)&&t.push(e),t}function i(t,e){return-1==t.indexOf(e)?(t.push(e),!0):!1}function o(t,e){var n=t.indexOf(e);return-1!=n?(t.splice(n,1),!0):!1}function s(t,e){return t.concat(e.filter(function(e){return-1==t.indexOf(e)}))}function a(t,e){return t.concat(e)}function h(t,e){return t.filter(function(t){return-1!=e.indexOf(t)})}function u(t,e){return t.filter(function(t){return-1==e.indexOf(t)})}function c(t,e){return t.every(function(t){return-1!=e.indexOf(t)})}function d(t){var e=r,n=t.reduce(e,[]);return n}t.clone=e,t.contains=n,t.build=r,t.add=i,t.remove=o,t.union=s,t.unionKnownDisjoint=a,t.intersect=h,t.difference=u,t.isSubset=c,t.fromArray=d}(e=t.arraySet||(t.arraySet={}));var n;!function(t){function e(t){var e={};for(var n in t)t[n]&&(e[n]=!0);return e}function n(t,e){return t[e]}function r(t,e){return t[e]=!0,t}function i(t,e){return t[e]?!1:t[e]=!0}function o(t,e){return t[e]?(delete t[e],!0):!1}function s(t,e,n){void 0===n&&(n=null);for(var r in t)e.call(n,r)}function a(t,e){var n={};for(var r in t)n[r]=!0;for(var r in e)n[r]=!0;return n}function h(t,e){var n={};for(var r in t)e[r]&&(n[r]=!0);return n}function u(t,e){var n={};for(var r in t)r in e||(n[r]=!0);return n}function c(t){return t.reduce(r,{})}t.clone=e,t.contains=n,t.build=r,t.add=i,t.remove=o,t.members=Object.keys,t.forEach=s,t.union=a,t.intersect=h,t.difference=u,t.fromArray=c}(n=t.stringSet||(t.stringSet={}));var r=function(){function t(){this.begin=0,this.end=0}return t.prototype.isEmpty=function(){return this.begin==this.end},t.prototype.isNotEmpty=function(){return this.begin!=this.end},t.prototype.enqueue=function(t){this[this.end++]=t},t.prototype.dequeue=function(){var t=this[this.begin];return this[this.begin]=void 0,++this.begin,this.begin>=this.end&&(this.begin=this.end=0),t},t.prototype.remove=function(t){for(var e=!1,n=this.begin,r=this.end;r>n;++n)e||this[n]!==t||(e=!0),e&&(this[n]=this[n+1]);e&&(--this.end,this.begin>=this.end&&(this.begin=this.end=0))},t}();t.Queue=r;var i=function(){function t(t){this.members=[],this.length=0,this.comesBefore=t}return t.prototype.contains=function(t){return this.members.indexOf(t)>=0},t.prototype.push=function(t){this.members.push(t),this.upheap(this.length),++this.length},t.prototype.pushAll=function(t){for(var e=0,n=t.length;n>e;++e)this.members.push(t[e]),this.upheap(this.length),++this.length},t.prototype.pop=function(){var t=this.members[0],e=this.members.pop();return--this.length>0&&(this.members[0]=e,this.downheap(0)),t},t.prototype.upheap=function(t){for(var e=this.members[t];t>0;){var n=Math.floor((t+1)/2)-1,r=this.members[n];if(!this.comesBefore(e,r))break;this.members[n]=e,this.members[t]=r,t=n}},t.prototype.downheap=function(t){for(var e=this.members.length,n=this.members[t];;){var r=2*t+1;if(!(e>r))break;var i=this.members[r],o=r+1;if(e>o){var s=this.members[o];this.comesBefore(s,i)&&(r=o,i=s)}if(!this.comesBefore(i,n))break;this.members[r]=n,this.members[t]=i,t=r}},t}();t.Heap=i}(e=t.utility||(t.utility={}))}(hd||(hd={}));var hd;!function(t){var e;!function(t){function e(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];var r=Array.prototype.slice.call(arguments,1);return function(){var e=Array.prototype.slice.call(arguments,0);return t.bind.apply(t,[null].concat(r,e))}}function n(){}function r(t){var e=t,n=Object.create(Object.getPrototypeOf(t));for(var r in e)e.hasOwnProperty(r)&&(n[r]=e[r]);return n}function i(t){var e=t,n=Array.isArray(t)?[]:Object.create(Object.getPrototypeOf(t));for(var r in e)e.hasOwnProperty(r)&&(n[r]="object"==typeof e[r]?i(e[r]):e[r]);return n}function o(t,e){return t.reduce(function(t,n){var r=e(n);return r in t?t[r].push(n):t[r]=[n],t},{})}function s(t,e,n){void 0===n&&(n=null);for(var r=[],i=0,o=t.length;o>i;++i){var s=e.call(n,t[i],i,t);Array.prototype.push.apply(r,Array.isArray(s)?s:[s])}return r}function a(t,e,n){void 0===n&&(n=null);for(var r=[],i=t.length-1;i>=0;--i)r.push(e.call(n,t[i],i,t));return r}function h(){for(var t=[],e=0,n=arguments.length;n>e;++e){var r=arguments[e];Array.isArray(r)?t.push.apply(t,r):void 0!==r&&t.push(r)}return t}function u(t,e){return t-e}function c(t,e){return t.valueOf()-e.valueOf()}function d(t){return function(e){return e instanceof t}}function p(t){return function(e){return!(e instanceof t)}}function l(t){return function(e){return e in t}}function f(t){return function(e){return!(e in t)}}function v(t){return function(e){return t[e]}}function g(t){return t.id}t.makeConstructorBinder=e,function(t){t[t.No=0]="No",t[t.Yes=1]="Yes",t[t.Maybe=2]="Maybe"}(t.Fuzzy||(t.Fuzzy={}));t.Fuzzy;t.noop=n,t.shallowCopy=r,t.deepCopy=i,t.partition=o,t.concatmap=s,t.reversemap=a,t.interpolate=h,t.numCompare=u,t.dateCompare=c,t.isType=d,t.isNotType=p,t.nameIsIn=l,t.nameIsNotIn=f,t.toValueIn=v,t.getId=g}(e=t.utility||(t.utility={}))}(hd||(hd={}));var hd;!function(){}(hd||(hd={})),hd.globalConsole=console;var hd;!function(t){var e;!function(e){function n(e){var n=t.globalConsole;return n[e]?n[e].bind(t.globalConsole):void 0}function r(t){e.console[t]=a[t]=s}function i(t){e.console[t]=a[t]=a}var o=function(){function t(){this.dir=e.noop,this.error=e.noop,this.group=e.noop,this.groupCollapsed=e.noop,this.groupEnd=e.noop,this.info=e.noop,this.log=e.noop,this.time=e.noop,this.timeEnd=e.noop,this.trace=e.noop,this.warning=e.noop,this.async=this,this.compile=this}return t}();e.Console=o,e.console=new o;var s=new o,a=new o;e.console.dir=s.dir=n("dir"),e.console.error=s.error=n("error"),e.console.group=s.group=n("group"),e.console.groupCollapsed=s.groupCollapsed=n("groupCollapsed"),e.console.groupEnd=s.groupEnd=n("groupEnd"),e.console.info=s.info=n("info"),e.console.log=s.log=n("log"),e.console.time=s.time=n("time"),e.console.timeEnd=s.timeEnd=n("timeEnd"),e.console.trace=s.trace=n("trace"),e.console.warning=s.warning=n("warning"),r("async"),i("compile"),e.enableConsole=r,e.disableConsole=i}(e=t.utility||(t.utility={}))}(hd||(hd={}));var hd;!function(t){var e;!function(t){function e(){do{for(var t=null,n=0;null===t&&n<o.length;++n){var r=o[n];r&&r.isNotEmpty()&&(t=r.dequeue())}t?(t.run(),--s):s=0}while(s>0);a=s?setTimeout(e,0):null}function n(n,r,h){for(var u=[],c=3;c<arguments.length;c++)u[c-3]=arguments[c];if(0>n){try{r.apply(h,u)}catch(d){t.console.error(d)}return null}var p=new i(n,r,h,u),l=o[n];return void 0===l&&(l=o[n]=new t.Queue),l.enqueue(p),++s,a||(a=setTimeout(e,0)),p}function r(t){var e=o[t.priority];e&&e.remove(t)}var i=function(){function e(t,e,n,r){this.priority=t,this.fn=e,this.thisArg=n,this.params=r}return e.prototype.run=function(){try{this.fn.apply(this.thisArg,this.params)}catch(e){t.console.error(e)}},e}();t.ScheduledTask=i;var o=[],s=0,a=null;t.schedule=n,t.deschedule=r}(e=t.utility||(t.utility={}))}(hd||(hd={}));var __extends=this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);n.prototype=e.prototype,t.prototype=new n},hd;!function(t){var e;!function(e){var n=t.utility;e.ObservablePriority=-1;var r=function(){function t(t,e,n,r,i){this.object=t,this.next_cb=e,this.error_cb=n,this.completed_cb=r,this.id=i}return t.prototype.onNext=function(t){this.next_cb&&this.next_cb.call(this.object,t,this.id)},t.prototype.onError=function(t){this.error_cb&&this.error_cb.call(this.object,t,this.id)},t.prototype.onCompleted=function(){this.completed_cb&&this.completed_cb.call(this.object,this.id)},t}();e.ProxyObserver=r;var i=function(){function t(){}return t.prototype.hasObservers=function(){return this["#observers"].length>0},t.prototype.addObserver=function(t,e,n,i,o){var s;return s=1==arguments.length?t:new r(t,e,n,i,o),this.hasOwnProperty("#observers")?this["#observers"].push(s):this["#observers"]=[s],s},t.prototype.removeObserver=function(t){for(var e=!1,n=this["#observers"].length;n>=0;--n){var i=this["#observers"][n];(i===t||i instanceof r&&i.object===t)&&(this["#observers"].splice(n,1),e=!0)}return e},t.prototype.sendNext=function(t){this["#observers"].slice(0).forEach(function(r){n.schedule(e.ObservablePriority,r.onNext,r,t)})},t.prototype.sendError=function(t){this["#observers"].slice(0).forEach(function(r){n.schedule(e.ObservablePriority,r.onError,r,t)})},t.prototype.sendCompleted=function(){this["#observers"].slice(0).forEach(function(t){n.schedule(e.ObservablePriority,t.onCompleted,t)}),delete this["#observers"]},t}();e.BasicObservable=i,i.prototype["#observers"]=[];var o=function(t){function e(e){t.call(this),this.completedCount=0,this.count=e.length,e.forEach(function(t){t.addObserver(this)})}return __extends(e,t),e.prototype.onNext=function(t){this.sendNext(t)},e.prototype.onError=function(t){this.sendError(t)},e.prototype.onCompleted=function(){++this.completedCount==this.count&&this.sendCompleted()},e}(i);e.Union=o}(e=t.reactive||(t.reactive={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){var n=t.utility;e.PropertyPriority=3;var r;!function(t){t[t.None=0]="None",t[t.Init=1]="Init",t[t.Update=2]="Update"}(r||(r={}));var i=function(t){function r(e,n){t.call(this),this.scheduled=0,this.needInit=null,this.value=e,n&&(this.eq=n)}return __extends(r,t),r.prototype.scheduleUpdate=function(){0===this.scheduled?(this.scheduled=2,n.schedule(e.PropertyPriority,this.update,this)):this.scheduled=2},r.prototype.scheduleInit=function(t){this.needInit?this.needInit.push(t):this.needInit=[t],0===this.scheduled&&(this.scheduled=1,n.schedule(e.PropertyPriority,this.update,this))},r.prototype.update=function(){var t=this.scheduled;this.scheduled=0;var r=this.needInit;this.needInit=null,2===t&&(this.hasValue(this.lastUpdate)?t=1:(this.lastUpdate=this.value,this.sendNext(this.value))),1===t&&r&&r.forEach(function(t){n.schedule(e.ObservablePriority,t.onNext,t,this.value)},this)},r.prototype.addObserverInit=function(e,n,r,i,o){var s;return s=1===arguments.length?t.prototype.addObserver.call(this,e):t.prototype.addObserver.call(this,e,n,r,i,o),s&&void 0!==this.value&&this.scheduleInit(s),s},r.prototype.set=function(t){this.hasValue(t)||(this.value=t,this.scheduleUpdate())},r.prototype.hardSet=function(t){this.value=t,this.scheduleUpdate()},r.prototype.get=function(){return this.value},r.prototype.hasValue=function(t){return this.eq?this.eq(this.value,t):this.value===t},r}(e.BasicObservable);e.ObservableProperty=i}(e=t.reactive||(t.reactive={}))}(hd||(hd={}));var hd;!function(t){var e;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.onNext=function(t){this.sendNext(t)},e.prototype.onError=function(t){this.sendError(t)},e.prototype.onCompleted=function(){this.sendCompleted()},e}(t.BasicObservable);t.Extension=e;var n=function(t){function e(e,n){t.call(this),this.fn=n&&n.length?e.bind.apply(e,[null].concat(n)):e}return __extends(e,t),e.prototype.onNext=function(t){try{this.sendNext(this.fn(t))}catch(e){this.sendError(e)}},e.prototype.onError=function(t){this.sendError(t)},e.prototype.onCompleted=function(){this.sendCompleted()},e}(e);t.FunctionExtension=n;var r=function(t){function e(e){t.call(this),this.exts=e=e?e.slice(0):[];for(var n=1,r=e.length;r>n;++n)e[n-1].addObserver(e[n]);n>1&&this.forward(e[r-1])}return __extends(e,t),e.prototype.forward=function(t){t.addObserver(this,this.sendNext,this.sendError,this.sendCompleted)},e.prototype.onNext=function(t){this.exts.length?this.exts[0].onNext(t):this.sendNext(t)},e.prototype.onError=function(t){this.exts.length?this.exts[0].onError(t):this.sendError(t)},e.prototype.onCompleted=function(){this.exts.length?this.exts[0].onCompleted():this.sendCompleted()},e.prototype.push=function(t){if(this.exts.length){var e=this.exts[this.exts.length-1];e.removeObserver(this),e.addObserver(t)}this.forward(t),this.exts.push(t)},e.prototype.pop=function(){if(this.exts.length){var t=this.exts.pop();t.removeObserver(this),this.exts.length&&this.forward(this.exts[this.exts.length-1])}return t},e.prototype.unshift=function(t){this.exts.length?t.addObserver(this.exts[0]):this.forward(t),this.exts.unshift(t)},e.prototype.shift=function(){if(this.exts.length){var t=this.exts.shift();t.removeObserver(this.exts.length?this.exts[0]:this)}return t},e}(t.BasicObservable);t.Chain=r;var i=function(t){function e(e){t.call(this),this.source=e,this.target=null,e.addObserverInit(this,this.onNextTarget,null,null)}return __extends(e,t),e.prototype.addObserverInit=function(){var e=t.prototype.addObserver.apply(this,arguments);return this.last&&e.onNext(this.last),e},e.prototype.onNextTarget=function(t){this.target&&this.target.removeObserver(this),this.target=t,this.target&&t.addObserverInit(this,this.onTargetNext,this.onTargetError,this.onTargetCompleted)},e.prototype.onNext=function(t){this.target&&this.target.onNext(t)},e.prototype.onError=function(t){this.target&&this.target.onError(t)},e.prototype.onCompleted=function(){this.target&&this.target.onCompleted()},e.prototype.onTargetNext=function(t){this.last=t,this.sendNext(t)},e.prototype.onTargetError=function(t){this.sendError(t)},e.prototype.onTargetCompleted=function(){this.sendCompleted(),this.target=null},e}(t.BasicObservable);t.HotSwap=i;var o=function(t){function e(e){t.call(this),this.time_ms=e}return __extends(e,t),e.prototype.onNext=function(t){setTimeout(this.sendNext.bind(this,t),this.time_ms)},e.prototype.onError=function(t){setTimeout(this.sendError.bind(this,t),this.time_ms)},e.prototype.onCompleted=function(){setTimeout(this.sendCompleted.bind(this),this.time_ms)},e}(e);t.Delay=o;var s;!function(t){t[t.None=0]="None",t[t.Next=1]="Next",t[t.Error=2]="Error"}(s||(s={}));var a=function(t){function e(e,n){void 0===e&&(e=400),t.call(this),this.state=0,this.task=null,this.time=e,this.flush=n,this.onTimeout=this.onTimeout.bind(this)}return __extends(e,t),e.prototype.onNext=function(t){void 0!==this.flush&&t===this.flush?this.task&&(clearTimeout(this.task),this.onTimeout()):(this.state=1,this.arg=t,this.task&&clearTimeout(this.task),this.task=setTimeout(this.onTimeout,this.time))},e.prototype.onError=function(t){this.state=2,this.arg=t,this.task&&clearTimeout(this.task),this.task=setTimeout(this.onTimeout,this.time)},e.prototype.onCompleted=function(){this.task&&(clearTimeout(this.task),this.onTimeout()),this.sendCompleted()},e.prototype.onTimeout=function(){1==this.state?this.sendNext(this.arg):2==this.state&&this.sendError(this.arg),this.state=0,this.task=null},e}(e);t.Stabilizer=a;var h=function(t){function e(e){t.call(this),this.replacement=e}return __extends(e,t),e.prototype.onError=function(){this.sendError(this.replacement)},e}(e);t.ReplaceError=h;var u=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.onNext=function(t){void 0===t||null===t||""===t?this.sendError("Required"):this.sendNext(t)},e}(e);t.Required=u;var c=function(t){function e(e){t.call(this),this.defaultValue=e}return __extends(e,t),e.prototype.onNext=function(t){this.sendNext(void 0===t||null===t||""===t?this.defaultValue:t)},e.prototype.onError=function(){this.sendNext(this.defaultValue)},e}(e);t.Default=c;var d=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.onNext=function(t){this.sendNext(void 0===t||null===t?"":t.toString())},e}(e);t.ToString=d;var p=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.onNext=function(t){this.sendNext(JSON.stringify(t))},e}(e);t.ToJson=p;var l=function(t){function e(e){if(void 0===e&&(e=0),t.call(this),this.scale=1,0>e)for(var n=0,r=e;n>r;--n)this.scale/=10;else for(var n=0,r=e;r>n;++n)this.scale*=10}return __extends(e,t),e.prototype.onNext=function(t){this.sendNext(Math.round(t*this.scale)/this.scale)},e}(e);t.Round=l;var f=function(t){function e(e){t.call(this),this.places=e}return __extends(e,t),e.prototype.onNext=function(t){this.sendNext(t.toFixed(this.places))},e}(e);t.NumberToFixed=f;var v=function(t){function e(e){t.call(this),this.sigfigs=e}return __extends(e,t),e.prototype.onNext=function(t){this.sendNext(t.toPrecision(this.sigfigs))},e}(e);t.NumberToPrecision=v;var g=function(t){function e(e){t.call(this),this.places=e}return __extends(e,t),e.prototype.onNext=function(t){this.sendNext(t.toExponential(this.places))},e}(e);t.NumberToExponential=g;var m=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.onNext=function(t){var e=Number(t);""==t||isNaN(e)||1/0===e?this.sendError("Invalid number"):this.sendNext(e)},e}(e);t.ToNumber=m;var y=function(t){function e(e){t.call(this),this.scale=1,this.scale=e}return __extends(e,t),e.prototype.onNext=function(t){this.sendNext(this.scale*t)},e}(e);t.ScaleNumber=y;var b=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.onNext=function(t){var e;""==t||isNaN((e=new Date(t)).getTime())?this.sendError("Invalid date"):this.sendNext(e)},e}(e);t.ToDate=b;var x=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.onNext=function(t){this.sendNext(t?t.toLocaleString():"")},e}(e);t.DateToString=x;var w=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.onNext=function(t){this.sendNext(t?t.toLocaleDateString():"")},e}(e);t.DateToDateString=w;var C=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.onNext=function(t){this.sendNext(t?t.toLocaleTimeString():"")},e}(e);t.DateToTimeString=C;var O=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.onNext=function(t){this.sendNext(t?t.getTime():0)},e}(e);t.DateToMilliseconds=O;var E=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.onNext=function(t){this.sendNext(new Date(t))},e}(e);t.MillisecondsToDate=E;var N=function(t){function e(e,n){t.call(this),this.dx=e,this.dy=n}return __extends(e,t),e.prototype.onNext=function(t){this.sendNext({x:t.x+this.dx,y:t.y+this.dy})},e}(e);t.Offset=N;var k=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.onNext=function(t){this.sendNext("("+t.x+", "+t.y+")")},e}(e);t.PointToString=k}(e=t.reactive||(t.reactive={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){function n(t,e,n,r,i){try{var o=t.call(e,n,r);i&&i.resolve(o)}catch(s){console.warn(s),i&&i.reject(s)}}function r(t,e,n){t.then(function(t){n(e,t)})}var i=t.utility;e.PromisePriority=2;var o,s=function(){function t(t,e,n,r,i,o){this.object=t,this.fulfilled_cb=e,this.rejected_cb=n,this.progress_cb=r,this.id=i,this.promise=o}return t.prototype.onFulfilled=function(t){this.fulfilled_cb?n(this.fulfilled_cb,this.object,t,this.id,this.promise):this.promise&&this.promise.resolve(t)},t.prototype.onRejected=function(t){this.rejected_cb?n(this.rejected_cb,this.object,t,this.id,this.promise):this.promise&&this.promise.reject(t)},t.prototype.onProgress=function(t){this.progress_cb&&n(this.progress_cb,this.object,t,this.id,void 0)},t}();!function(t){t[t.Pending=0]="Pending",t[t.Fulfilled=1]="Fulfilled",t[t.Rejected=2]="Rejected"}(o||(o={})),function(t){t[t.Unknown=0]="Unknown",t[t.Used=1]="Used",t[t.Unused=2]="Unused",t[t.Delayed=3]="Delayed"}(e.Usage||(e.Usage={}));var a=(e.Usage,function(t){function n(n){t.call(this),this.state=0,this.open=!0,this.usage=new e.ObservableProperty(0),this.ondropped=new e.BasicObservable,arguments.length>0&&this.resolve(n)}return __extends(n,t),n.prototype.isFulfilled=function(){return 1===this.state},n.prototype.isRejected=function(){return 2===this.state},n.prototype.isPending=function(){return 0===this.state},n.prototype.isSettled=function(){return 0!==this.state},n.prototype.inspect=function(){return 1===this.state?{state:"fulfilled",value:this.value}:2===this.state?{state:"rejected",reason:this.reason}:{state:"pending"}},n.prototype.addDependency=function(t,n,r,o,a){var h;return h=1==arguments.length?t:new s(t,n,r,o,a),0!==this.state?i.schedule(e.PromisePriority,this.dischargeDependency,this,h):(e.plogger&&0==this.dependencies.length&&e.plogger.nowHasDependencies(this),this.hasOwnProperty("dependencies")?this.dependencies.push(h):this.dependencies=[h]),0===this.usage.get()&&this.usage.set(1),h},n.prototype.bindDependency=function(t,e,n,r,i,o){var s;if(arguments.length<3){var a=e;s=this.addDependency(e,a.onFulfilled,a.onRejected,a.onProgress)}else s=this.addDependency(e,n,r,i,o);return s.promise=t,s},n.prototype.removeDependency=function(t){for(var n=!1,r=this.dependencies.length-1;r>=0;--r){var i=this.dependencies[r];(i===t||i instanceof s&&i.object===t)&&(this.dependencies.splice(r,1),0==this.dependencies.length&&(e.plogger&&e.plogger.lostAllDependencies(this),this.ondropped.sendNext(this)),n=!0)}return n},n.prototype.hasDependencies=function(){return this.dependencies.length>0},n.prototype.resolve=function(t){this.open&&this.resolveFirst(t)},n.prototype.resolveFirst=function(t){0===this.state&&(t===this?this.reject(new TypeError("Attempted to resolve a promise with itself")):t instanceof n?(this.open=!1,t.addDependency(this)):"object"!=typeof t&&"function"!=typeof t||"function"!=typeof t.then?this.fulfill(t):(this.open=!1,this.resolveThen(t)))},n.prototype.resolveThen=function(t){var e=!0,n=this;try{t.then(function(t){e&&(e=!1,n.resolve(t))},function(t){e&&(e=!1,n.reject(t))},function(t){e&&n.notify(t)})}catch(r){e&&(e=!1,n.reject(r))}},n.prototype.fulfill=function(t){this.state=1,this.value=t,e.plogger&&e.plogger.isSettled(this);var n=this.dependencies;i.schedule(e.PromisePriority,function(){for(var e=0,r=n.length;r>e;++e)n[e].onFulfilled(t)},this),this.sendNext(t),delete this.dependencies,this.sendCompleted(),this.ondropped.sendCompleted()},n.prototype.reject=function(t){this.open&&this.rejectFirst(t)},n.prototype.rejectFirst=function(t){if(0===this.state){this.state=2,this.reason=t,e.plogger&&e.plogger.isSettled(this);var n=this.dependencies;i.schedule(e.PromisePriority,function(){for(var e=0,r=n.length;r>e;++e)n[e].onRejected(t)},this),this.sendError(t),delete this.dependencies,this.sendCompleted(),this.ondropped.sendCompleted()}},n.prototype.dischargeDependency=function(t){1===this.state?t.onFulfilled(this.value):2===this.state&&t.onRejected(this.reason)},n.prototype.notify=function(t){this.open&&this.notifyFirst(t)},n.prototype.notifyFirst=function(t){if(0==this.state){var n=this.dependencies;i.schedule(e.PromisePriority,function(){for(var e=0,r=n.length;r>e;++e)n[e].onProgress(t)},this),this.sendNext(t)}},n.prototype.then=function(t,e,r){if("function"!=typeof t&&(t=null),"function"!=typeof e&&(e=null),"function"!=typeof r&&(r=null),t||e||r){var i=new n;return this.bindDependency(i,null,t,e,r),i}return this},n.prototype.catch=function(t){if("function"==typeof t){var e=new n;return this.bindDependency(e,null,null,t,null),e}return this},n.prototype.progress=function(t){if("function"==typeof t){var e=new n;return this.bindDependency(e,null,null,null,t),e}return this},n.prototype.onError=function(){},n.prototype.onCompleted=function(){},n.all=function(){if(arguments.length)for(var t=new n,e=[],i=0,o=arguments.length,s=function(n,r){e[n]=r,++i==o&&t.resolve(e)},a=0;a<arguments.length;++a)r(arguments[a],a,s);else var t=new n([]);return t},n}(e.BasicObservable));e.Promise=a,a.prototype.onFulfilled=a.prototype.resolveFirst,a.prototype.onRejected=a.prototype.rejectFirst,a.prototype.onProgress=a.prototype.notifyFirst,a.prototype.onNext=a.prototype.removeDependency,a.prototype.dependencies=[]}(e=t.reactive||(t.reactive={}))}(hd||(hd={}));var hd;!function(t){var e;!function(t){var e=function(e){function n(n){e.call(this),this.promises=[new t.Promise(n)]}return __extends(n,e),n.prototype.isSettled=function(){return 1==this.promises.length&&this.promises[0].isSettled()},n.prototype.isCurrent=function(){return this.promises[0].isFulfilled()},n.prototype.currentPromise=function(){return this.promises[this.promises.length-1]},n.prototype.addPromise=function(e){if(this.promises.push(e),e instanceof t.Promise)e.addDependency(this,this.onPromiseFulfilled,this.onPromiseRejected,this.onPromiseProgress,e);else{var n=this;e.then(function(t){n.onPromiseFulfilled(t,e)},function(t){n.onPromiseRejected(t,e)},function(t){n.onPromiseProgress(t,e)})}},n.prototype.selectPromise=function(e){var n=this.promises.indexOf(e);if(0>n)return!1;for(var r=0;n>r;++r){var i=this.promises[r];i instanceof t.Promise&&i.removeDependency(this)}return n>0&&this.promises.splice(0,n),!0},n.prototype.onPromiseFulfilled=function(t,e){this.selectPromise(e)&&this.sendNext(t)},n.prototype.onPromiseRejected=function(t,e){this.selectPromise(e)&&this.sendError(t)},n.prototype.onPromiseProgress=function(t,e){this.selectPromise(e)&&this.sendNext(t)},n}(t.BasicObservable);t.PromiseLadder=e}(e=t.reactive||(t.reactive={}))}(hd||(hd={}));var hd;!function(t){var e;!function(t){function e(t,e,i){return void 0===e&&(e=1),void 0===i&&(i=null),function(){for(var o=[],s=0;s<arguments.length;s++)o[s-0]=arguments[s];var a=new n(o,i),h=new r(t,a.promise,e);return h.outputPromises.length<=1?h.outputPromises[0]:h.outputPromises}}t.liftFunction=e;var n=function(){function e(e,n){this.values=[],this.numFulfilled=0;var r=e.length;if(this.inputs=e,this.values.length=r,this.promise=new t.Promise,t.plogger&&t.plogger.register(this.promise,"parampack","parameter pack"),this.promise.ondropped.addObserver(this),r)for(var i=0;r>i;++i)n&&n[i]?this.onParameterFulfilled(e[i],i):e[i].addDependency(this,this.onParameterFulfilled,this.onParameterRejected,this.onParameterProgress,i);else this.promise.resolve(this.values)}return e.prototype.onParameterFulfilled=function(t,e){this.values[e]=t,++this.numFulfilled==this.values.length?this.promise.resolve(this.values):this.promise.notify(this.values)},e.prototype.onParameterRejected=function(){this.promise.reject("Failed dependency")},e.prototype.onParameterProgress=function(t,e){this.values[e]=t,this.promise.notify(this.values)},e.prototype.onNext=function(){this.inputs.forEach(function(t){t.removeDependency(this)},this),this.promise.ondropped.removeObserver(this)},e.prototype.onError=function(){},e.prototype.onCompleted=function(){},e}();t.ParameterPack=n;var r=function(){function e(e,n,r){this.outputPromises=[],this.fn=e,this.parameters=n,n.addDependency(this);for(var i=0;r>i;++i){var o=new t.Promise;o.ondropped.addObserver(this),this.outputPromises.push(o)}}return e.prototype.onFulfilled=function(e){var n=this.outputPromises.length;try{var r=this.fn.apply(null,e);if(1==n)r=[r];else if(!Array.isArray(r))throw new TypeError("Multi-output method did not return array");for(var i=0;n>i;++i)this.outputPromises[i].resolve(r[i]),r[i]instanceof t.Promise&&!r[i].isSettled()&&this.outputPromises[i].ondropped.addObserver(r[i])}catch(o){console.error(o);for(var i=0;n>i;++i)this.outputPromises[i].reject(o)}},e.prototype.onRejected=function(t){for(var e=this.outputPromises.length,n=0;e>n;++n)this.outputPromises[n].reject(t)},e.prototype.onProgress=function(){},e.prototype.onNext=function(){var t=this.outputPromises.some(function(t){return t.hasDependencies()});t||(this.parameters.removeDependency(this),this.outputPromises.forEach(function(t){t.ondropped.removeObserver(this)}))},e.prototype.onError=function(){},e.prototype.onCompleted=function(){},e}();t.SingleFunctionCall=r}(e=t.reactive||(t.reactive={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){var n=t.utility,r=function(){function t(){this.count=1,this.outstanding=[]}return t.prototype.register=function(t,e){t.id?console.error("Logging problem: attempt to re-register promise "+t.id):t.id=e+"#"+this.count++},t.prototype.checkId=function(t){t.id||this.register(t,"unknown")},t.prototype.nowHasDependencies=function(t){this.checkId(t),n.arraySet.add(this.outstanding,t),console.log("Promise expected: "+t.id)},t.prototype.lostAllDependencies=function(t){this.checkId(t),n.arraySet.remove(this.outstanding,t),console.log("Promise dropped:  "+t.id)},t.prototype.isSettled=function(t){this.checkId(t),n.arraySet.remove(this.outstanding,t),console.log("Promise settled:  "+t.id)},t.prototype.report=function(){return console.log(this.outstanding.length?"Outstanding: "+this.outstanding.map(function(t){return t.id}).join(", "):"No outstanding promises"),this.outstanding},t}();e.PromiseLogger=r}(e=t.reactive||(t.reactive={}))}(hd||(hd={}));var hd;!function(t){var e;!function(t){var e=function(){function t(){this.visited={},this.collected=[];var t=this;this.collected.and=function(){return t}}return t.prototype.result=function(){return this.collected},t.prototype.collect=function(t,e){return Array.isArray(e)?e.forEach(function(e){this.collectRec(t,e)},this):this.collectRec(t,e),this.collected},t.prototype.collectRec=function(t,e){if(!this.visited[e]){this.visited[e]=!0,t>=0&&this.collected.push(e);var n=this.edges[e];for(var r in n)this.collectRec(-t,r)}},t}();t.DfsWalker=e}(e=t.graph||(t.graph={}))}(hd||(hd={}));var __extends=this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);n.prototype=e.prototype,t.prototype=new n},hd;!function(t){var e;!function(t){var e=function(){function t(){this.labels={},this.ins={},this.outs={}}return t.prototype.hasNode=function(t){return t in this.outs},t.prototype.hasEdge=function(t,e){return this.hasNode(t)&&this.outs[t][e]},t.prototype.getLabel=function(t){return this.labels[t]},t.prototype.setLabel=function(t,e){void 0===e?delete this.labels[t]:this.labels[t]=e},t.prototype.addNode=function(t,e){void 0!==e&&(this.labels[t]=e),this.outs[t]={},this.ins[t]={}},t.prototype.addEdge=function(t,e){this.outs[t][e]=!0,this.ins[e][t]=!0},t.prototype.addEdgeTo=function(t){var e=this;return function(n){e.addEdge(n,t)}},t.prototype.addEdgeFrom=function(t){var e=this;return function(n){e.addEdge(t,n)}},t.prototype.removeNode=function(t){delete this.labels[t];for(var e in this.outs[t])delete this.ins[e][t];for(var n in this.ins[t])delete this.outs[n][t];delete this.outs[t],delete this.ins[t]},t.prototype.removeEdge=function(t,e){delete this.outs[t][e],delete this.ins[e][t]},t.prototype.getNodes=function(){return Object.keys(this.outs)},t.prototype.getLabeledNodes=function(){return Object.keys(this.labels)},t.prototype.getUnlabeledNodes=function(){return Object.keys(this.outs).filter(function(t){return!(t in this.labels)})},t.prototype.getOutsFor=function(t){var e=[],n=this.outs[t];for(var r in n)n[r]&&e.push(r);return e},t.prototype.getInsFor=function(t){var e=[],n=this.ins[t];for(var r in n)n[r]&&e.push(r);return e},t}();t.Digraph=e;var n=function(t){function e(e){t.call(this),this.digraph=e}return __extends(e,t),e.prototype.nodesDownstream=function(t){return this.edges=this.digraph.outs,this.collect(0,t)},e.prototype.nodesDownstreamSameType=function(t){return this.edges=this.digraph.outs,this.collect(1,t)},e.prototype.nodesDownstreamOtherType=function(t){return this.edges=this.digraph.outs,this.collect(-1,t)},e.prototype.nodesUpstream=function(t){return this.edges=this.digraph.ins,this.collect(0,t)},e.prototype.nodesUpstreamSameType=function(t){return this.edges=this.digraph.ins,this.collect(1,t)},e.prototype.nodesUpstreamOtherType=function(t){return this.edges=this.digraph.ins,this.collect(-1,t)},e}(t.DfsWalker);t.DigraphWalker=n}(e=t.graph||(t.graph={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){var n=t.utility,r=function(){function t(){this.graph=new e.Digraph}return t.prototype.constraintsFor=function(t){var e={};return t.forEach(function(t){e[this.graph.getLabel(t)]=!0},this),Object.keys(e)},t.prototype.addVariable=function(t){this.graph.addNode(t)},t.prototype.addMethod=function(t,e,n,r){this.graph.addNode(t,e),n.forEach(this.graph.addEdgeTo(t)),r.forEach(this.graph.addEdgeFrom(t))},t.prototype.removeVariable=function(t){this.graph.removeNode(t)},t.prototype.removeMethod=function(t){this.constraintForMethod(t);this.graph.removeNode(t)},t.prototype.variables=function(){return this.graph.getUnlabeledNodes()},t.prototype.methods=function(){return this.graph.getLabeledNodes()},t.prototype.constraints=function(){return this.constraintsFor(this.graph.getLabeledNodes())
},t.prototype.contains=function(t){return this.graph.hasNode(t)},t.prototype.methodsWhichInput=function(t){return this.graph.getOutsFor(t)},t.prototype.methodsWhichOutput=function(t){return this.graph.getInsFor(t)},t.prototype.methodsWhichUse=function(t){var e=this.graph.getInsFor(t),r=this.graph.getOutsFor(t);return n.arraySet.union(e,r)},t.prototype.constraintsWhichInput=function(t){return this.constraintsFor(this.methodsWhichInput(t))},t.prototype.constraintsWhichOutput=function(t){return this.constraintsFor(this.methodsWhichOutput(t))},t.prototype.constraintsWhichUse=function(t){return this.constraintsFor(this.methodsWhichUse(t))},t.prototype.inputsForMethod=function(t){return this.graph.getInsFor(t)},t.prototype.outputsForMethod=function(t){return this.graph.getOutsFor(t)},t.prototype.variablesForMethod=function(t){var e=this.graph.getInsFor(t),r=this.graph.getOutsFor(t);return n.arraySet.union(e,r)},t.prototype.constraintForMethod=function(t){return this.graph.getLabel(t)},t.prototype.inputsForConstraint=function(t){var e=this.methodsForConstraint(t),r=e.map(this.graph.getInsFor,this.graph);return r.reduce(n.arraySet.union,[])},t.prototype.outputsForConstraint=function(t){var e=this.methodsForConstraint(t),r=e.map(this.graph.getOutsFor,this.graph);return r.reduce(n.arraySet.union,[])},t.prototype.variablesForConstraint=function(t){var e=this.methodsForConstraint(t),r=e.map(this.graph.getInsFor,this.graph),i=e.map(this.graph.getOutsFor,this.graph),o=r.reduce(n.arraySet.union,[]),s=i.reduce(n.arraySet.union,[]);return n.arraySet.union(o,s)},t.prototype.methodsForConstraint=function(t){return this.methods().filter(function(e){return this.graph.getLabel(e)==t},this)},t}();e.NoCachingConstraintGraph=r;var i=function(t){function e(){t.apply(this,arguments),this.vids={},this.cids={}}return __extends(e,t),e.prototype.addVariable=function(e){t.prototype.addVariable.call(this,e),this.vids[e]=!0},e.prototype.addMethod=function(e,r,i,o){t.prototype.addMethod.call(this,e,r,i,o),r in this.cids?n.arraySet.add(this.cids[r],e):this.cids[r]=[e]},e.prototype.removeVariable=function(e){delete this.vids[e],t.prototype.removeVariable.call(this,e)},e.prototype.removeMethod=function(e){var r=this.graph.getLabel(e),i=this.cids[r];n.arraySet.remove(i,e),0==i.length&&delete this.cids[r],t.prototype.removeMethod.call(this,e)},e.prototype.variables=function(){return Object.keys(this.vids)},e.prototype.constraints=function(){return Object.keys(this.cids)},e.prototype.methodsForConstraint=function(t){var e=this.cids[t];return e?n.arraySet.clone(e):[]},e}(r);e.CachingConstraintGraph=i}(e=t.graph||(t.graph={}))}(hd||(hd={}));var hd;!function(t){var e;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.selectMethod=function(t,e,n,r){e||(e=null);var i=this.selectedForConstraint(t);i!=e&&(i&&this.removeMethod(i),e&&this.addMethod(e,t,n,r))},e.prototype.selectedForConstraint=function(t){var e=this.methodsForConstraint(t);return e?e[0]:null},e}(t.CachingConstraintGraph);t.CachingSolutionGraph=e}(e=t.graph||(t.graph={}))}(hd||(hd={}));var hd;!function(t){var e;!function(t){function e(t){return t+"#sm"}function n(t){return t+"#sc"}function r(t){return"#sm"==t.substr(-3)}function i(t){return"#sm"!=t.substr(-3)}function o(t){return"#sc"==t.substr(-3)}function s(t){return"#sc"!=t.substr(-3)}t.stayMethod=e,t.stayConstraint=n,t.isStayMethod=r,t.isNotStayMethod=i,t.isStayConstraint=o,t.isNotStayConstraint=s}(e=t.graph||(t.graph={}))}(hd||(hd={}));var hd;!function(t){var e;!function(t){t.debugIds=!0;var e={},n=0,r=function(){function r(t){this.namespace=t,!t||t in e||(e[t]=++n),this.count=0}return r.prototype.makeId=function(n){var r=[];return t.debugIds&&r.push(n),r.push("#"),this.namespace&&(t.debugIds?r.push(this.namespace,"."):r.push(e[this.namespace],".")),r.push(++this.count),r.join("")},r}();t.IdGenerator=r}(e=t.model||(t.model={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){var n=(t.utility,t.reactive);!function(t){t[t.changed=0]="changed",t[t.touched=1]="touched",t[t.pending=2]="pending",t[t.settled=3]="settled",t[t.setOutput=4]="setOutput"}(e.VariableEventType||(e.VariableEventType={}));var r=(e.VariableEventType,function(){function t(t,e,r,i,o){this.error=new n.ObservableProperty(null),this.source=new n.ObservableProperty(!1),this.pending=new n.ObservableProperty(!1),this.contributing=new n.ObservableProperty(1),this.relevant=new n.ObservableProperty(1),this.changes=new n.BasicObservable,this.id=t,this.name=e,this.value=new n.ObservableProperty(r,i),this.output=new n.ObservableProperty(!!o),this.ladder=new n.PromiseLadder(r),this.ladder.addObserver(this,this.onLadderNext,this.onLadderError,null)}return t.prototype.toString=function(){return this.name},t.prototype.setOutput=function(t){t=!!t,this.output.hasValue(t)||(this.output.set(t),this.changes.sendNext({type:4,vv:this,isOutput:t}))},t.prototype.makePromise=function(t){this.ladder.addPromise(t),0==this.pending.get()&&(this.pending.set(!0),this.changes.sendNext({type:2,vv:this}))},t.prototype.getPromise=function(){return this.ladder.currentPromise()},t.prototype.addObserver=function(){return this.value.addObserver.apply(this.value,arguments)},t.prototype.addObserverInit=function(){return this.value.addObserverInit.apply(this.value,arguments)},t.prototype.removeObserver=function(t){return this.value.removeObserver(t)},t.prototype.onNext=function(t){this.ladder.isCurrent()&&this.value.hasValue(t)?this.changes.sendNext({type:1,vv:this}):(this.makePromise(new n.Promise(t)),this.changes.sendNext({type:0,vv:this}))},t.prototype.onError=function(t){var e=new n.Promise;e.reject(t),this.makePromise(e),this.changes.sendNext({type:0,vv:this})},t.prototype.onCompleted=function(){},t.prototype.onLadderNext=function(t){this.value.hardSet(t),this.error.set(null),this.ladder.isSettled()&&(this.pending.set(!1),this.changes.sendNext({type:3,vv:this}))},t.prototype.onLadderError=function(t){this.error.set(t),this.ladder.isSettled()&&(this.pending.set(!1),this.changes.sendNext({type:3,vv:this}))},t}());e.Variable=r}(e=t.model||(t.model={}))}(hd||(hd={}));var hd;!function(t){var e;!function(t){var e=function(){function t(t,e,n,r,i,o,s){this.id=t,this.name=e,this.inputVars=n,this.outputVars=r,this.fn=i,this.inputs=o,this.outputs=s}return t.prototype.toString=function(){return this.name},t}();t.Method=e}(e=t.model||(t.model={}))}(hd||(hd={}));var hd;!function(t){var e;!function(t){var e=function(){function t(t,e,n){this.variables=[],this.methods=[],this.id=t,this.name=e,this.variables=n}return t.prototype.toString=function(){return this.name},t.prototype.addMethod=function(t){this.methods.push(t)},t.WeakestStrength=Number.MIN_VALUE,t.RequiredStrength=Number.MAX_VALUE,t}();t.Constraint=e}(e=t.model||(t.model={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){var n=t.reactive;!function(t){t[t.addConstraint=0]="addConstraint",t[t.removeConstraint=1]="removeConstraint"}(e.ModelculeEventType||(e.ModelculeEventType={}));var r=(e.ModelculeEventType,function(){function t(){this.constraints=[],this.changes=new n.BasicObservable}return t}());e.ModelculeData=r;var i=function(){function t(){}return t.defineProperty=function(t,e,r,i){if(i){var o=new n.ObservableProperty(r);Object.defineProperty(t,"$"+e,{configurable:!0,enumerable:!1,value:o}),Object.defineProperty(t,e,{configurable:!0,enumerable:!0,get:o.get.bind(o),set:o.set.bind(o)})}else t[e]=r},t.constraints=function(t){return t["#hd_data"].constraints},t.changes=function(t){return t["#hd_data"].changes},t.addVariable=function(e,n,r,i){r&&t.defineProperty(e,r,n,i)},t.addConstraint=function(e,n,r,i){e["#hd_data"].constraints.push(n),r&&t.defineProperty(e,r,n,i),e["#hd_data"].changes.sendNext({type:0,constraint:n})},t}();e.Modelcule=i,Object.defineProperty(i.prototype,"#hd_data",{get:function(){var t=new r;return Object.defineProperty(this,"#hd_data",{value:t}),t}})}(e=t.model||(t.model={}))}(hd||(hd={}));var hd;!function(t){var e;!function(t){var e;!function(t){function e(t){function e(){var t=c[d++];if(t.match(/^\.?\d/))return new i(t);if(t.match(/^[\w$]/))return new o(t);if("-"===t){var n=e();return new s("-",n)}if("("===t){if(n=r(),t=c[d++],")"!==t)throw"Expected ')' but found '"+t+"''";return n}throw"Expected value but found '"+t+"'"}function n(){for(var t=e(),n=c[d];"*"===n||"/"===n;){++d;var r=e();t=new a(t,n,r),n=c[d]}return t}function r(){for(var t=n(),e=c[d];"+"===e||"-"===e;){++d;var r=n();t=new a(t,e,r),e=c[d]}return t}function u(){var t=r(),e=c[d++];if(!e||!e.match(/^[<>=]=$/))throw"Expected equality but found '"+e+"'";var n=r();return new h(t,e,n)}var c=t.match(/((\d+(\.\d*)?)|(\.\d+))([eE][+-]?\d+)?|[\w$]+|[<>=]=|\S/g),d=0,p=u();if(d===c.length)return p;throw"Unexpected token after equation ended: '"+c[d]+"'"}function n(t,e,n){var i=r(n,e);if(i){var s,a=[],h=1;do{do s="d"+h++;while(s==e||t.indexOf(s)>=0);var u=i.extractDivisor(s);u&&(u instanceof o?a.push("if ("+u.name+" == 0) return "+e+";"):(a.push("var "+s+" = "+u.print()+";"),a.push("if ("+s+" == 0) return "+e+";")))}while(u);return"=="==n.op?a.push("return "+i.print()+";"):(a.push("if ("+n.left.print()+n.op+n.right.print()+")"),a.push("  return "+e+";"),a.push("else"),a.push("  return "+i.print()+";")),a.join("\n")}return null}function r(t,e){function n(t,e){if(0==r.length)return e;if(t instanceof s){var i=t;return r.shift(),n(i.expr,new s(i.op,e))}if(t instanceof a){var o=t;if("+"===o.op)return"left"===r.shift()?n(o.left,new a(e,"-",o.right)):n(o.right,new a(e,"-",o.left));if("-"===o.op)return"left"===r.shift()?n(o.left,new a(e,"+",o.right)):n(o.right,new a(o.left,"-",e));if("*"===o.op)return"left"===r.shift()?n(o.left,new a(e,"/",o.right)):n(o.right,new a(e,"/",o.left));if("/"===o.op)return"left"===r.shift()?n(o.left,new a(e,"*",o.right)):n(o.right,new a(o.left,"/",e))}}var r=t.left.find(e);return r?n(t.left,t.right):(r=t.right.find(e),r?n(t.right,t.left):null)}var i=function(){function t(t){this.text=t}return t.prototype.print=function(){return this.text},t.prototype.hasVar=function(){return!1},t.prototype.find=function(){return null},t.prototype.extractDivisor=function(){return null},t}();t.Number=i;var o=function(){function t(t){this.name=t}return t.prototype.print=function(){return this.name},t.prototype.hasVar=function(){return!0},t.prototype.find=function(t){return this.name==t?[]:null},t.prototype.extractDivisor=function(){return null},t}();t.Variable=o;var s=function(){function t(t,e){this.op=t,this.expr=e}return t.prototype.print=function(){return"("+this.op+this.expr.print()+")"},t.prototype.hasVar=function(){return this.expr.hasVar()},t.prototype.find=function(t){var e=this.expr.find(t);return e&&e.unshift("expr"),e},t.prototype.extractDivisor=function(t){return this.expr.extractDivisor(t)},t}();t.UnaryOperation=s;var a=function(){function t(t,e,n){this.left=t,this.op=e,this.right=n,this.extracted=!1}return t.prototype.print=function(){return"("+this.left.print()+this.op+this.right.print()+")"},t.prototype.hasVar=function(){return this.left.hasVar()||this.right.hasVar()},t.prototype.find=function(t){var e=this.left.find(t);return e?e.unshift("left"):(e=this.right.find(t),e&&e.unshift("right")),e},t.prototype.extractDivisor=function(t){var e=this.right.extractDivisor(t);return e||(e=this.left.extractDivisor(t),e||"/"!=this.op||this.extracted||(this.right.hasVar()&&(e=this.right,this.right instanceof o||(this.right=new o(t))),this.extracted=!0)),e},t}();t.BinaryOperation=a;var h=function(){function t(t,e,n){this.left=t,this.op=e,this.right=n}return t}();t.Equation=h,t.parse=e,t.fnBody=n}(e=t.eqn||(t.eqn={}))}(e=t.model||(t.model={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){function n(t){return i(t,h)}function r(t){return i(t,u)}function i(t,e){return e.test(t)?t.replace(e,""):null}var o=t.utility,s=t.reactive,a=function(){function t(){this.last=null;var t,n;arguments.length>0&&("string"==typeof arguments[0]?(t=arguments[0],arguments.length>1&&(n=arguments[1])):n=arguments[0]),this.target=n?n:new e.Modelcule,this.ids=new e.IdGenerator(t)}return t.prototype.end=function(){return this.endConstraint(),this.target},t.prototype.variable=function(t,n,i,o){this.endConstraint();var s=!1,a=r(t);if(a&&(s=!0,t=a),this.invalidName(t)||this.nameInUse(t))return this;if(i&&"function"!=typeof i)return console.error("Variable equality predicate must be a function"),this;var h;return n instanceof e.Variable?(h=n,n=void 0):h=new e.Variable(this.ids.makeId(t),t,n,i),h.setOutput(o?!0:!1),e.Modelcule.addVariable(this.target,h,t,s),this},t.prototype.variables=function(){this.endConstraint();var t,e,n;return"string"==typeof arguments[0]?(t=arguments[0].trim().split(/\s*,\s*/),e=arguments[1]||{},n=arguments[2]):(e=arguments[0],t=Object.keys(e),n=arguments[1]),t.forEach(function(t){this.variable(t,e[t],void 0,n)},this),this},t.prototype.outputVariable=function(t,n,r){return this.endConstraint(),1==arguments.length&&this.target[t]instanceof e.Variable?this.target[t].setOutput(!0):this.variable(t,n,r,!0),this},t.prototype.interfaceVariable=function(t,n,r){return this.endConstraint(),1==arguments.length&&this.target[t]instanceof e.Variable?this.target[t].setOutput(!1):this.variable(t,n,r,!1),this},t.prototype.outputVariables=function(){return this.endConstraint(),1==arguments.length&&"string"==typeof arguments[0]?arguments[0].trim().split(/\s*,\s*/).forEach(function(t){this.outputVariable(t)},this):arguments.length>1?this.variables(arguments[0],arguments[1],!0):this.variables(arguments[0],!0),this},t.prototype.interfaceVariables=function(){return this.endConstraint(),1==arguments.length&&"string"==typeof arguments[0]?arguments[0].trim().split(/\s*,\s*/).forEach(function(t){this.interfaceVariable(t)},this):arguments.length>1?this.variables(arguments[0],arguments[1],!1):this.variables(arguments[0],!1),this},t.prototype.asyncMethod=function(t,e){return this.method(t,e,!0)},t.prototype.method=function(t,r,i){void 0===i&&(i=!1);var a,h,u=t.trim().split(/\s*->\s*/);if(2!=u.length)return console.error('Invalid method signature: "'+t+'"'),this;a=""==u[0]?[]:u[0].split(/\s*,\s*/),h=""==u[1]?[]:u[1].split(/\s*,\s*/);for(var c=[],d=0,p=a.length;p>d;++d){var l=n(a[d]);l&&(c[d]=!0,a[d]=l)}if(0==c.length&&(c=null),a.some(this.unknownName,this)||h.some(this.unknownName,this))return this;var f=a.map(o.toValueIn(this.target)),v=h.map(o.toValueIn(this.target));if(v.some(o.isNotType(e.Variable)))return this;var g=this.last.variables,m=function(t){return g.indexOf(t)<0},y=o.arraySet.fromArray(f.filter(o.isType(e.Variable))),b=o.arraySet.fromArray(v.filter(o.isType(e.Variable)));if(y.some(m))return console.error("Input does not belong to constraint in method "+t),this;if(b.some(m))return console.error("Output does not belong to constraint in method "+t),this;y=o.arraySet.difference(g,b);var x=new e.Method(this.ids.makeId(t),t,y,b,i?r:s.liftFunction(r,v.length,c),f,v);return this.last.addMethod(x),this},t.prototype.constraint=function(t){this.endConstraint();var n=t.trim().split(/\s*,\s*/);if(n.some(this.unknownName,this))return this;var r=n.map(o.toValueIn(this.target));if(!r.every(o.isType(e.Variable)))return console.error("Constraint may only contain variables"),this;var i=new e.Constraint(this.ids.makeId(t),t,r);return this.last=i,this},t.prototype.endConstraint=function(){return this.last&&(e.Modelcule.addConstraint(this.target,this.last),this.last=null),this},t.prototype.equation=function(t){this.endConstraint();try{var n=e.eqn.parse(t)}catch(r){return console.error(r),this}var i=t.match(/[a-zA-Z_$][\w$]*/g);if(i.some(this.unknownName,this))return console.error('Unknown variables in equation: "'+t+'"'),this;for(var a=0,h=i.length;h>a;++a)if(i.indexOf(i[a],a+1)>-1)return console.error('Duplicate variables in equation: "'+t+'"'),this;var u=i.map(o.toValueIn(this.target)),c=u.slice(0),d=c.filter(o.isType(e.Variable)),p=i.join(", "),l=new e.Constraint(this.ids.makeId(p),p,u);try{for(var f=function(t){return t!==g},a=0,h=i.length;h>a;++a){var v=i[a],g=this.target[v];if(g instanceof e.Variable){var m=p+" -> "+v,y=e.eqn.fnBody(i,v,n),b=[null].concat(i);b.push(y);var x=new(Function.bind.apply(Function,b)),w=new e.Method(this.ids.makeId(m),m,d.filter(f),[g],s.liftFunction(x),c,[g]);l.addMethod(w)}}e.Modelcule.addConstraint(this.target,l)}catch(C){console.error("Unable to create equation",C)}return this},t.prototype.syncommand=function(t,n,r){this.endConstraint();var i=n.trim().split(/\s*,\s*/);if(i.some(this.unknownName,this))return this;var s=i.map(o.toValueIn(this.target));if(!s.every(o.isType(e.Variable)))return console.error("Command may only reference variables"),this;var a=new e.SynchronousCommand(r,s);return this.target[t]=a,this},t.prototype.invalidName=function(t){return t.match(/^[a-zA-Z$][\w\d$]*$/)?!1:(console.error('Invalid modelcule field name: "'+t+'"'),!0)},t.prototype.nameInUse=function(t){return this.target.hasOwnProperty(t)?(console.error('Cannot redefine modelcule field "'+t+'"'),!0):!1},t.prototype.unknownName=function(t){return this.target.hasOwnProperty(t)?!1:(console.error('Unknown modelcule field "'+t+'"'),!0)},t}();e.ModelBuilder=a,a.prototype.v=a.prototype.variable,a.prototype.vs=a.prototype.variables,a.prototype.ov=a.prototype.outputVariable,a.prototype.ovs=a.prototype.outputVariables,a.prototype.iv=a.prototype.interfaceVariable,a.prototype.ivs=a.prototype.interfaceVariables,a.prototype.c=a.prototype.constraint,a.prototype.m=a.prototype.method,a.prototype.a=a.prototype.asyncMethod,a.prototype.eq=a.prototype.equation;var h=/^\s*\*\s*/,u=/^\s*\$\s*/}(e=t.model||(t.model={}))}(hd||(hd={}));var __extends=this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);n.prototype=e.prototype,t.prototype=new n},hd;!function(t){var e;!function(e){var n=t.reactive,r=function(t){function e(e,n){t.call(this),this.properties=null,this.start=e,this.path=n,this.followPath()}return __extends(e,t),e.prototype.get=function(){return this.result},e.prototype.addObserverInit=function(e,n,r,i,o){if(this.properties){var s;return s=1===arguments.length?t.prototype.addObserver.call(this,e):t.prototype.addObserver.call(this,e,n,r,i,o),s&&s.onNext(this.result),s}1==arguments.length?e.onNext(this.result):n.call(e,this.result,o)},e.prototype.followPath=function(){for(var t=[],e=this.start,n=0,r=this.path.length;null!=e&&r>n;++n){var i=this.path[n],o="$"+i;if(o in e){var s=e[o];s.addObserver(this,this.onChange,null,null),t.push(s),e=s.get()}else e=e[i]}e!==this.result&&(this.result=e,this.sendNext(e)),t.length>0?this.properties=t:this.sendCompleted()},e.prototype.onChange=function(){this.properties&&(this.properties.forEach(function(t){t.removeObserver(this)},this),this.properties=null),this.followPath()},e}(n.BasicObservable);e.Path=r}(e=t.model||(t.model={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){function n(t){return t.value.get()}var r=t.reactive,i=function(t){function e(e){t.call(this),this.cache=[],this.observables=e,this.cache.length=e.length;for(var n=0,r=0,i=e.length;i>r;++r)"function"==typeof e[r].addObserverInit?e[r].addObserverInit(this,this.onNext,null,null,n++):e[r].addObserver(this,this.onNext,null,null,n++)}return __extends(e,t),e.prototype.onNext=function(t,e){this.cache[e]=t?!0:!1;for(var n=!0,r=0,i=this.cache.length;i>r;++r){if(void 0===this.cache[r])return;n=n&&!this.cache[r]}this.result!==n&&(this.result=n,this.sendNext(n))},e.prototype.addObserverInit=function(e,n,r,i,o){var s;return s=1===arguments.length?t.prototype.addObserver.call(this,e):t.prototype.addObserver.call(this,e,n,r,i,o),s&&void 0!==this.result&&s.onNext(this.result),s},e.prototype.get=function(){return this.result},e}(r.BasicObservable);e.None=i;var o=function(){function t(t,e){this.fn=t,this.args=e;for(var n=[],r=0,o=e.length;o>r;++r){var s=e[r];n.push(s.pending),n.push(s.error)}this.ready=new i(n)}return t.prototype.onNext=function(){this.ready.get()&&this.fn.apply(null,this.args.map(n))},t.prototype.onError=function(){},t.prototype.onCompleted=function(){},t}();e.SynchronousCommand=o}(e=t.model||(t.model={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){function n(t,e,n){var r={};t.variables().forEach(function(t){u.stringSet.add(r,t)});for(var i in n.compmids){for(var o=n.compmids[i],s={},a=0,h=o.length;h>a;++a){var c=o[a];s=e.outputsForMethod(c).reduce(u.stringSet.build,s)}var d=u.stringSet.difference(r,s);t.addMethod(i,n.id,u.stringSet.members(d),u.stringSet.members(s))}}function r(t,e){var r=new c.CachingConstraintGraph;return t.variables().forEach(r.addVariable,r),n(r,t,e),r}function i(t){for(var e=t.constraints().filter(c.isNotStayConstraint).map(p.fromPrimitive.bind(null,t));e.length>1;){for(var n=[],r=0,i=e.length;i>r;r+=2)n.push(i>r+1?o(e[r],e[r+1],t):e[r]);e=n}return e[0]}function o(t,e,n){for(var r=u.arraySet.unionKnownDisjoint(t.cids,e.cids),i=new p(r),o=t.getMethodIds(),a=e.getMethodIds(),h=o.length-1;h>=0;--h)for(var d=o[h],l=a.length-1;l>=0;--l){var f=a[l],v=u.arraySet.unionKnownDisjoint(t.getPrimitiveIdsForMethod(d),e.getPrimitiveIdsForMethod(f)),g=new c.Digraph;n.variables().forEach(g.addNode,g),v.forEach(function(t){var e=n.inputsForMethod(t),r=n.outputsForMethod(t);g.addNode(t),e.forEach(g.addEdgeTo(t)),r.forEach(g.addEdgeFrom(t))}),s(g,v.reduce(u.stringSet.build,{}))&&i.addMethod(v)}return i}function s(t,e){var n={},r=[],i=t.getNodes(),o=!1;if(i.forEach(function(i){var s=t.getInsFor(i).length;n[i]=s,0==s?r.push(i):s>1&&!e[i]&&(o=!0)}),o)return!1;for(var s=function(t){0==--n[t]&&r.push(t)},a=0;r.length>0;){var h=r.pop();++a,t.getOutsFor(h).forEach(s)}return a==i.length}function a(t){var e="composite";if(d.debugIds){var n=[];t.forEach(function(t){0!=n.length&&n.push(" + "),n.push("(",t.substring(0,t.indexOf("#")),")")}),e=n.join("")}return l.makeId(e)}function h(t){var e="composite";if(d.debugIds){var n=[];t.forEach(function(t){0!=n.length&&n.push(" + "),n.push("(",t.substring(0,t.indexOf("#")),")")}),e=n.join("")}return l.makeId(e)}var u=t.utility,c=t.graph,d=t.model,p=function(){function t(t){this.compmids={},this.cids=t,this.id=a(this.cids)}return t.fromPrimitive=function(e,n){var r=new t([n]);return e.methodsForConstraint(n).forEach(r.addMethod,r),r},t.prototype.getMethodIds=function(){return Object.keys(this.compmids)},t.prototype.getPrimitiveIdsForMethod=function(t){return this.compmids[t]},t.prototype.addMethod=function(t){Array.isArray(t)||(t=[t]);var e=h(t);this.compmids[e]=t},t}();e.CompositeConstraint=p,e.addCompositeMethods=n,e.makeConstraintGraph=r,e.composeAllConstraints=i;var l=new d.IdGenerator}(e=t.dfa||(t.dfa={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){function n(t,e){for(var n,r=t.getRoot(),i=1==t.order?e.length-1:0,o=1==t.order?-1:1;r&&!(n=t.getLeafValue(r));){var s=t.getTransitions(r)[e[i]];s&&(r=s),i+=o}return n?n:null}var r=t.utility;!function(t){t[t.Low=0]="Low",t[t.High=1]="High"}(e.Order||(e.Order={}));var i=(e.Order,function(){function t(){this.transitions={},this.leafs={},this.root=null,this.count=0}return t.prototype.addNode=function(t){var e="n"+this.count++;return this.count%1e3==0&&r.console.compile.error(this.count+" nodes..."),this.transitions[e]=t,e},t.prototype.getNodes=function(){return Object.keys(this.transitions)},t.prototype.getTransitions=function(t){return this.transitions[t]},t.prototype.setRoot=function(t){this.root=t},t.prototype.getRoot=function(){return this.root},t.prototype.addLeaf=function(t){return this.leafs[t]=!0,t},t.prototype.getLeafValue=function(t){return this.leafs[t]?t:null},t}());e.SoftLinkedDfa=i;var o=function(){function t(){this.nodes=[],this.root=null}return t.prototype.addNode=function(t){return this.nodes.push(t),t},t.prototype.getNodes=function(){return this.nodes},t.prototype.getTransitions=function(t){return t},t.prototype.setRoot=function(t){this.root=t},t.prototype.getRoot=function(){return this.root},t.prototype.addLeaf=function(t){return t},t.prototype.getLeafValue=function(t){return"string"==typeof t?t:null},t}();e.HardLinkedDfa=o,e.runDfa=n}(e=t.dfa||(t.dfa={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){function n(t,e,n){var r=e.constraints().filter(i.isNotStayConstraint);if(1!=r.length)return void console.error("Cannot compile a constraint graph to a decision tree unless it consists of a single constraint");for(var s={},a=e.methodsForConstraint(r[0]),h=0,u=a.length;u>h;++h){var c=a[h],d=e.inputsForMethod(c);s[c]=d.map(i.stayConstraint)}var p=e.variables().map(i.stayConstraint),l=new o(s,p);l.buildDfa(t,n)}var r=t.utility,i=t.graph;e.compileToDfa=n;var o=function(){function t(t,e){this.pathCache={},this.transCache={},this.count=0,this.max=0,this.planInputs=t,this.inputs=e}return t.prototype.buildDfa=function(t,e){this.dfa=t,this.dfa.order=e,this.count=0,this.max=this.inputs.length*(this.inputs.length-1),t.setRoot(0==e?this.buildLowTreeNode([],this.inputs):this.buildHighTreeNode([],this.inputs,Object.keys(this.planInputs)))},t.prototype.supplyNode=function(t){var e=Object.keys(t);e.sort();var n=[];e.forEach(function(e){n.push(e,t[e])});var r=n.join(","),i=this.transCache[r];return i?i:this.transCache[r]=this.dfa.addNode(t)},t.prototype.buildHighTreeNode=function(t,e,n){var i={},o=t.slice(0);o.sort();var s=o.join(","),a=this.pathCache[s];if(a)return a;for(var h=0,u=0,c=e.length;c>u;++u){1==t.length&&(++this.count,r.console.compile.error(this.count+"/"+this.max));var d=e.shift(),p=n.filter(function(t){return-1!=this.planInputs[t].indexOf(d)},this);1==p.length?(i[d]=this.dfa.addLeaf(p[0]),++h):p.length>0&&p.length<n.length&&(t.push(d),i[d]=this.buildHighTreeNode(t,e,p),t.pop(),++h),e.push(d)}return 0==h&&console.error("Building decision tree node with no transitions (we should have already found a solution by this point)"),this.pathCache[s]=this.supplyNode(i)},t.prototype.buildLowTreeNode=function(t,e){for(var n={},i=0,o=0,s=e.length;s>o;++o){1==t.length&&(++this.count,r.console.compile.error(this.count+"/"+this.max));var a=e.shift(),h=this.pickPlanFromLow(t,e);h?(n[a]=this.dfa.addLeaf(h),++i):(t.push(a),n[a]=this.buildLowTreeNode(t,e),t.pop(),++i),e.push(a)}return this.supplyNode(n)},t.prototype.pickPlanFromLow=function(t,e){var n=[];for(var i in this.planInputs)r.arraySet.isSubset(e,this.planInputs[i])&&n.push(i);for(var o=t.length-1;o>=0&&n.length>1;){var s=n.filter(function(e){return-1!=this.planInputs[e].indexOf(t[o])},this);s.length>0&&(n=s),--o}return 1==n.length?n[0]:null},t}()}(e=t.dfa||(t.dfa={}))}(hd||(hd={}));var hd;!function(t){var e;!function(t){var e=function(){function t(){this.strongest=0,this.weakest=0,this.strengths={}}return t.prototype.setToMax=function(t){this.strengths[t]=++this.strongest},t.prototype.setToMin=function(t){this.strengths[t]=--this.weakest},t.prototype.remove=function(t){delete this.strengths[t]},t.prototype.isRequired=function(t){return!(t in this.strengths)},t.prototype.getOptionalsUnordered=function(){return Object.keys(this.strengths)},t.prototype.weaker=function(t,e){return t in this.strengths?e in this.strengths?this.strengths[t]<this.strengths[e]:!0:!1},t.prototype.stronger=function(t,e){return t in this.strengths?e in this.strengths?this.strengths[t]>this.strengths[e]:!1:!(e in this.strengths)},t}();t.NumericStrengthAssignment=e;var n=function(){function t(){this.strengths=[]}return t.prototype.setToMax=function(t){var e=this.strengths.indexOf(t);e>=0&&this.strengths.splice(e,1),this.strengths.push(t)},t.prototype.setToMin=function(t){var e=this.strengths.indexOf(t);e>=0&&this.strengths.splice(e,1),this.strengths.unshift(t)},t.prototype.setOptionals=function(t){this.strengths=t},t.prototype.remove=function(t){var e=this.strengths.indexOf(t);e>=0&&this.strengths.splice(e,1)},t.prototype.getList=function(){return this.strengths},t.prototype.stronger=function(t,e){var n=this.strengths.indexOf(t),r=this.strengths.indexOf(e);return n>=0?r>=0?n>r:!1:0>r},t}();t.ListStrengthAssignment=n}(e=t.plan||(t.plan={}))}(hd||(hd={}));var __extends=this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);n.prototype=e.prototype,t.prototype=new n},hd;!function(t){var e;!function(e){function n(t){return function(e,n){return t.variablesForConstraint(n).forEach(function(t){e.contains(t)||e.addVariable(t)}),t.methodsForConstraint(n).forEach(function(r){e.addMethod(r,n,t.inputsForMethod(r),t.outputsForMethod(r))}),e}}var r=t.utility,i=t.graph,o=function(){function t(t){this.strengths=new e.NumericStrengthAssignment,this.cgraph=t}return t.prototype.getOptionals=function(){var t=this.strengths.getOptionalsUnordered();return t.sort(this.strengths.weaker.bind(this.strengths)),t},t.prototype.setOptionals=function(t){this.strengths=new e.NumericStrengthAssignment,t.forEach(this.strengths.setToMax,this.strengths)},t.prototype.removeOptional=function(t){this.strengths.remove(t)},t.prototype.setMaxStrength=function(t){this.strengths.setToMax(t)},t.prototype.setMinStrength=function(t){this.strengths.setToMin(t)},t.prototype.isStronger=function(t,e){return this.strengths.stronger(t,e)},t.prototype.plan=function(t,e){var n=this.sgraph=new s;this.cgraph.variables().forEach(n.addVariable,n),t&&this.cgraph.constraints().forEach(function(e){var r=t.selectedForConstraint(e);r&&n.addMethod(r,e,this.cgraph.inputsForMethod(r),this.cgraph.outputsForMethod(r))},this);var r=new h(this.cgraph,this.strengths,n,e);return r.run()},t.prototype.getSGraph=function(){return this.sgraph},t}();e.QuickPlanner=o;var s=function(t){function e(){t.apply(this,arguments),this.changes={}}return __extends(e,t),e.prototype.selectMethod=function(e,n,r,i){var o=this.selectedForConstraint(e);o!=n&&(e in this.changes?this.changes[e].mid==n&&delete this.changes[e]:this.changes[e]={mid:o,inputs:o?this.inputsForMethod(o):null,outputs:o?this.outputsForMethod(o):null},t.prototype.selectMethod.call(this,e,n,r,i))},e.prototype.rollback=function(){for(var e in this.changes)t.prototype.selectMethod.call(this,e,this.changes[e].mid,this.changes[e].inputs,this.changes[e].outputs);this.changes={}},e.prototype.commit=function(){this.changes={}},e}(i.CachingSolutionGraph);e.QPSolutionGraph=s;var a=function(){function t(t,e,o,s){this.strongestRetractedCid=null,this.undeterminedVids={},this.cidToEnforce=t,this.strengths=o,this.sgraph=s;var a=new i.DigraphWalker(s.graph).nodesUpstreamOtherType(e.variablesForConstraint(t)).map(e.constraintForMethod,e),h=n(e);this.subcgraph=new i.CachingConstraintGraph,this.subcgraph=a.reduce(h,this.subcgraph),this.subcgraph=h(this.subcgraph,t),this.retractableCids=new r.Heap(o.weaker.bind(o)),this.retractableCids.pushAll(this.subcgraph.constraints().filter(this.isRetractable,this)),this.freeVarQueue=this.subcgraph.variables().filter(this.isFreeVar,this)}return t.prototype.targetConstraintSatisfied=function(){return void 0!==this.sgraph.selectedForConstraint(this.cidToEnforce)},t.prototype.getStrongestRetractedCid=function(){return this.strongestRetractedCid},t.prototype.getUndeterminedVids=function(){return r.stringSet.members(this.undeterminedVids)},t.prototype.run=function(){for(this.enforceConstraintsForAnyFreeVariables();!this.targetConstraintSatisfied()&&this.retractableCids.length>0;){var t=this.retractableCids.pop();this.determineConstraint(t,void 0),this.enforceConstraintsForAnyFreeVariables()}return this.targetConstraintSatisfied()?(this.sgraph.commit(),!0):(this.sgraph.rollback(),!1)},t.prototype.enforceConstraintsForAnyFreeVariables=function(){for(;!this.targetConstraintSatisfied()&&this.freeVarQueue.length>0;){var t=this.freeVarQueue.pop(),e=this.subcgraph.constraintsWhichOutput(t);if(1==e.length){var n=e[0],r=this.bestSelectableMethod(n);r&&this.determineConstraint(n,r)}}},t.prototype.bestSelectableMethod=function(t){var e=this.subcgraph.methodsForConstraint(t),n=null,r=0;return e.forEach(function(t){var e=this.subcgraph.outputsForMethod(t);e.every(this.isFreeVar,this)&&(null===n||r>e.length)&&(n=t,r=e.length)},this),n},t.prototype.determineConstraint=function(t,e){var n=this.sgraph.selectedForConstraint(t);n&&this.sgraph.outputsForMethod(n).forEach(this.makeUndetermined,this),this.sgraph.selectMethod(t,e,this.subcgraph.inputsForMethod(e),this.subcgraph.outputsForMethod(e)),e&&this.sgraph.outputsForMethod(e).forEach(this.makeDetermined,this);
var r=this.subcgraph.outputsForConstraint(t);this.subcgraph.methodsForConstraint(t).forEach(this.subcgraph.removeMethod,this.subcgraph),this.freeVarQueue=this.freeVarQueue.concat(r.filter(this.isFreeVar,this)),void 0!==e||null!==this.strongestRetractedCid&&!this.strengths.weaker(this.strongestRetractedCid,t)||(this.strongestRetractedCid=t)},t.prototype.isFreeVar=function(t){var e=this.subcgraph.constraintsWhichOutput(t);return 1==e.length},t.prototype.isRetractable=function(t){return this.strengths.weaker(t,this.cidToEnforce)},t.prototype.makeUndetermined=function(t){r.stringSet.add(this.undeterminedVids,t)},t.prototype.makeDetermined=function(t){r.stringSet.remove(this.undeterminedVids,t)},t}(),h=function(){function t(t,e,n,i){this.cgraph=t,this.sgraph=n,this.strengths=e,this.cidsToEnforce=new r.Heap(e.stronger.bind(e)),this.cidsToEnforce.pushAll(i)}return t.prototype.run=function(){for(var t=!0;this.cidsToEnforce.length>0;){var e=this.cidsToEnforce.pop(),n=new a(e,this.cgraph,this.strengths,this.sgraph);if(n.run()){var r=n.getStrongestRetractedCid();if(r){var i=this.collectDownstreamUnenforced(e,r,n.getUndeterminedVids());i.forEach(function(t){this.cidsToEnforce.contains(t)||this.cidsToEnforce.push(t)},this)}}else this.strengths.isRequired(e)&&(t=!1)}return t},t.prototype.collectDownstreamUnenforced=function(t,e,n){var o=this.sgraph.selectedForConstraint(t),s=r.arraySet.union(this.sgraph.outputsForMethod(o),n),a=new i.DigraphWalker(this.sgraph.graph).nodesDownstreamSameType(s),h=a.map(this.cgraph.constraintsWhichOutput,this.cgraph).reduce(function(t,e){return e.reduce(r.stringSet.build,t)},{});return r.stringSet.members(h).filter(function(t){return this.strengths.weaker(t,e)&&void 0===this.sgraph.selectedForConstraint(t)},this)},t}()}(e=t.plan||(t.plan={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){var n=t.graph,r=function(){function t(t,n,r,i){this.cidIndexes={},this.cidCount=0,this.strengths=new e.ListStrengthAssignment,this.cidIndexes=t,this.cidCount=Object.keys(t).length,this.mids=n,this.fn=r,this.cgraph=i}return t.prototype.getOptionals=function(){var t=[];for(var e in this.cidIndexes)t[this.cidIndexes[e]]=e;return this.strengths.getList().map(function(e){return t[e]})},t.prototype.setOptionals=function(t){for(var e=0,n=t.length;n>e;++e){var r=t[e];r in this.cidIndexes||(this.cidIndexes[r]=this.cidCount++)}this.strengths.setOptionals(t.map(function(t){return this.cidIndexes[t]},this))},t.prototype.removeOptional=function(){console.error("Cannot make modifications to constraint graph with DFA planner")},t.prototype.setMaxStrength=function(t){var e=this.cidIndexes[t];void 0===e&&(e=this.cidIndexes[t]=this.cidCount++),this.strengths.setToMax(e)},t.prototype.setMinStrength=function(t){var e=this.cidIndexes[t];void 0===e&&(e=this.cidIndexes[t]=this.cidCount++),this.strengths.setToMin(e)},t.prototype.isStronger=function(t,e){return this.strengths.stronger(this.cidIndexes[t],this.cidIndexes[e])},t.prototype.plan=function(){var t=this.fn.call(null,this.strengths.getList());return t?(this.selectedMethods=t,!0):!1},t.prototype.getSGraph=function(){var t=new n.CachingSolutionGraph;this.cgraph.variables().forEach(t.addVariable,t);for(var e=0,r=this.selectedMethods.length;r>e;++e){var i=this.mids[this.selectedMethods[e]];t.addMethod(i,this.cgraph.constraintForMethod(i),this.cgraph.inputsForMethod(i),this.cgraph.outputsForMethod(i))}return t},t}();e.DfaFnPlanner=r}(e=t.plan||(t.plan={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){var n=t.graph,r=t.dfa,i=function(){function t(t){this.compcgraph=new n.CachingConstraintGraph,this.strengths=new e.ListStrengthAssignment,this.cgraph=t,this.recompose()}return t.prototype.getOptionals=function(){return this.strengths.getList()},t.prototype.setOptionals=function(t){this.strengths.setOptionals(t)},t.prototype.removeOptional=function(t){this.strengths.remove(t)},t.prototype.setMaxStrength=function(t){this.strengths.setToMax(t)},t.prototype.setMinStrength=function(t){this.strengths.setToMin(t)},t.prototype.isStronger=function(t,e){return this.strengths.stronger(t,e)},t.prototype.plan=function(t,e){return e.some(n.isNotStayConstraint)&&this.recompose(),this.selected=r.runDfa(this.dfa,this.strengths.getList()),this.selected?!0:!1},t.prototype.getSGraph=function(){var t=new n.CachingSolutionGraph;this.cgraph.variables().forEach(t.addVariable,t);for(var e=this.composite.compmids[this.selected],r=0,i=e.length;i>r;++r){var o=e[r];t.addMethod(o,this.cgraph.constraintForMethod(o),this.cgraph.inputsForMethod(o),this.cgraph.outputsForMethod(o))}return t},t.prototype.recompose=function(){this.composite=r.composeAllConstraints(this.cgraph),this.compcgraph.methods().forEach(this.compcgraph.removeMethod,this.compcgraph),this.compcgraph.variables().forEach(this.compcgraph.removeVariable,this.compcgraph),this.cgraph.variables().forEach(this.compcgraph.addVariable,this.compcgraph),r.addCompositeMethods(this.compcgraph,this.cgraph,this.composite),this.dfa=new r.SoftLinkedDfa,r.compileToDfa(this.dfa,this.compcgraph,1)},t}();e.ComposedPlanner=i}(e=t.plan||(t.plan={}))}(hd||(hd={}));var __extends=this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);n.prototype=e.prototype,t.prototype=new n},hd;!function(t){var e;!function(e){var n=t.utility,r=t.reactive;!function(t){t[t.Irrelevant=1]="Irrelevant",t[t.AssumedRelevant=2]="AssumedRelevant",t[t.Relevant=3]="Relevant"}(e.Label||(e.Label={}));var i=(e.Label,function(t){function e(){t.apply(this,arguments),this.selected={},this.labels={},this.scheduled=!1}return __extends(e,t),e.prototype.selectMethod=function(t,e){var n=this.selected[t];n&&n!=e&&delete this.labels[n],e&&(this.labels[e]={}),this.selected[t]=e,this.schedule()},e.prototype.getLabel=function(t,e){var n=this.labels[e];if(n){var r=n[t];return r?r:2}return 2},e.prototype.setLabel=function(t,e,n){var r=this.labels[e];r&&r[t]!==n&&(r[t]=n,this.schedule())},e.prototype.removeConstraint=function(t){for(var e=0,n=t.length;n>e;++e)delete t[e]},e.prototype.schedule=function(){this.scheduled||(this.scheduled=!0,n.schedule(4,this.notify,this))},e.prototype.notify=function(){this.scheduled=!1,this.sendNext(this)},e}(r.BasicObservable));e.EnablementLabels=i}(e=t.enable||(t.enable={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){var n=(t.reactive,function(){function t(t,e,n,r){this.completedCount=0,this.egraph=t,this.mid=e,this.inputVids=Object.keys(n),this.outputCount=r.length;for(var i in n)n[i].usage.addObserverInit(this,this.onNextUsage,null,null,i);for(var o=0,s=r.length;s>o;++o)r[o].addObserver(this,null,null,this.onCompletedOutput)}return t.prototype.onCompletedOutput=function(){if(++this.completedCount==this.outputCount&&this.egraph)for(var t=0,e=this.inputVids.length;e>t;++t){var n=this.inputVids[t];2===this.egraph.getLabel(n,this.mid)&&this.egraph.setLabel(n,this.mid,1)}},t.prototype.onNextUsage=function(t,e){this.egraph&&(1===t?this.egraph.setLabel(e,this.mid,3):2===t?this.egraph.setLabel(e,this.mid,1):this.completedCount<this.outputCount&&this.egraph.setLabel(e,this.mid,2))},t.prototype.cancel=function(){this.egraph=null},t}());e.EnableReporter=n;var r=function(){function t(t){this.reporters={},this.cgraph=t,this.egraph=new e.EnablementLabels}return t.prototype.methodScheduled=function(t,e,r){var i=this.cgraph.constraintForMethod(t);this.egraph.selectMethod(i,t),this.reporters[i]&&this.reporters[i].cancel(),this.reporters[i]=new n(this.egraph,t,e,r)},t}();e.EnablementManager=r}(e=t.enable||(t.enable={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){function n(t,e,n){function r(n,o){if(o>(i[n]||0)){i[n]=o;for(var s=t.methodsWhichOutput(n),a=0,h=s.length;h>a;++a){var u=s[a],c=t.inputsForMethod(u);c.sort(function(t,n){return e.getLabel(n,u)-e.getLabel(t,u)});for(var d=0,p=c.length;p>d;++d){var l=c[d],f=Math.min(o,e.getLabel(l,u));r(l,f)}}}}var i={};return n.forEach(function(t){r(t,3)}),i}function r(t,e,n,r){function o(r){if(n[r]&&i(t,s))return!0;for(var a=t.methodsWhichInput(r),h=0,u=a.length;u>h;++h){var c=a[h],d=t.constraintForMethod(c);if(!s[d]&&1!==e.getLabel(r,c)){s[d]=c;for(var p=t.outputsForMethod(c),l=0,f=p.length;f>l;++l)if(o(p[l]))return!0;s[d]=null}}return!1}var s={};return o(r)?1:0}function i(t,e){function n(){for(var n=t.constraints(),r=0,i=n.length;i>r;++r){var s=n[r];if(!o.isStayConstraint(s))if(e[s])for(var h=t.outputsForMethod(e[s]),l=0,f=h.length;f>l;++l)d[h[l]]=-1;else{u[s]=!0,++c;for(var h=t.outputsForConstraint(s),l=0,f=h.length;f>l;++l){var v=h[l],g=d[v];-1!=g&&(d[v]=g?g+1:1)}}}p=t.variables().filter(a)}function r(){for(;c>0&&p.length>0;){var e=p.pop(),n=t.constraintsWhichOutput(e).filter(h);if(1==n.length){var r=n[0];i(r)&&s(r)}}}function i(e){for(var n=t.methodsForConstraint(e),r=0,i=n.length;i>r;++r){var o=n[r],s=t.outputsForMethod(o);if(s.every(a))return!0}return!1}function s(e){u[e]=!1,--c;t.outputsForConstraint(e).forEach(function(t){1==--d[t]&&p.push(t)})}function a(t){return 1==d[t]}function h(t){return u[t]}var u={},c=0,d={},p=[];return n(),r(),0==c}var o=(t.utility,t.graph);e.globalContributingCheck=n,e.relevancyCheck=r}(e=t.enable||(t.enable={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){var n=t.utility,r=t.reactive,i=t.model,o=t.graph,s=t.plan,a=t.enable;e.SystemUpdatePriority=1,e.defaultPlannerType=s.QuickPlanner,function(t){t[t.None=0]="None",t[t.Immediate=1]="Immediate",t[t.Scheduled=2]="Scheduled"}(e.Update||(e.Update={}));var h=(e.Update,function(){function t(t,n){void 0===t&&(t=e.defaultPlannerType),void 0===n&&(n=o.CachingConstraintGraph),this.sgraph=null,this.variables={},this.methods={},this.constraints={},this.updateOnVariableChange=2,this.updateOnModelChange=2,this.isUpdateScheduled=!1,this.isUpdateNeeded=!1,this.solved=new r.ObservableProperty(!0),this.needEnforcing={},this.needEvaluating={},this.pendingCount=0,this.outputVids={},this.cgraph=new n,t&&(this.planner=new t(this.cgraph)),this.enable=new a.EnablementManager(this.cgraph),this.enable.egraph.addObserver(this,this.onNextEgraph,null,null)}return t.prototype.getCGraph=function(){return this.cgraph},t.prototype.getSGraph=function(){return this.sgraph},t.prototype.getPlanner=function(){return this.planner||(this.planner=new e.defaultPlannerType(this.cgraph)),this.planner},t.prototype.switchToNewPlanner=function(t){var e=new t(this.cgraph);if(this.planner){var r=this.planner;e.setOptionals(r.getOptionals())}this.planner=e,this.cgraph.constraints().reduce(n.stringSet.build,this.needEnforcing),this.modelUpdate()},t.prototype.addComponent=function(t){return t instanceof i.ModelBuilder?void console.error("ModelBuilder passed to addComponent - did you forget to call end()?"):(i.Modelcule.constraints(t).forEach(this.addConstraint,this),void i.Modelcule.changes(t).addObserver(this,this.onNextModelculeEvent,null,null))},t.prototype.removeComponent=function(t){i.Modelcule.constraints(t).forEach(this.removeConstraint,this),i.Modelcule.changes(t).removeObserver(this)},t.prototype.onNextModelculeEvent=function(t){switch(t.type){case 0:this.addConstraint(t.constraint);break;case 1:this.removeConstraint(t.constraint)}},t.prototype.addConstraint=function(t){t.id in this.constraints||(this.constraints[t.id]=t,t.variables.forEach(this.addVariable,this),t.methods.forEach(this.addMethod.bind(this,t.id))),this.needEnforcing[t.id]=!0,this.modelUpdate()},t.prototype.removeConstraint=function(t){t.id in this.constraints&&(delete this.constraints[t.id],t.methods.forEach(this.removeMethod),t.variables.forEach(this.removeVariable))},t.prototype.addMethod=function(t,e){e.id in this.methods||(this.methods[e.id]=e,this.cgraph.addMethod(e.id,t,e.inputVars.map(n.getId),e.outputVars.map(n.getId)))},t.prototype.removeMethod=function(t){t.id in this.methods&&(delete this.methods[t.id],this.cgraph.removeMethod(t.id))},t.prototype.addVariable=function(t){if(!(t.id in this.variables)){this.variables[t.id]=t,t.pending.get()&&++this.pendingCount,t.output.get()&&(this.outputVids[t.id]=!0),t.changes.addObserver(this,this.onNextVariableChange,null,null);var e=o.stayMethod(t.id),n=o.stayConstraint(t.id);this.cgraph.addVariable(t.id),this.cgraph.addMethod(e,n,[],[t.id]),void 0===t.value.get()?this.getPlanner().setMinStrength(n):this.getPlanner().setMaxStrength(n),this.needEnforcing[n]=!0}},t.prototype.removeVariable=function(t){if(t.id in this.variables&&0==this.cgraph.constraintsWhichUse(t.id).length){delete this.variables[t.id],delete this.outputVids[t.id],delete this.needEnforcing[e],delete this.needEvaluating[e],t.changes.removeObserver(this);var e=o.stayConstraint(t.id);this.cgraph.removeMethod(o.stayMethod(t.id)),this.planner.removeOptional(e),this.cgraph.removeVariable(t.id)}},t.prototype.onNextVariableChange=function(t){switch(t.type){case 1:this.variableTouched(t.vv);break;case 0:this.variableChanged(t.vv);break;case 4:this.variableIsOutput(t.vv,t.isOutput);case 2:++this.pendingCount;break;case 3:this.pendingCount>0&&(--this.pendingCount,0!=this.pendingCount||this.isUpdateNeeded||this.solved.set(!0))}},t.prototype.variableTouched=function(t){var e=o.stayConstraint(t.id);this.getPlanner().setMaxStrength(e),this.sgraph&&this.sgraph.selectedForConstraint(e)||(this.needEnforcing[e]=!0,this.variableUpdate())},t.prototype.variableChanged=function(t){var e=o.stayConstraint(t.id);this.getPlanner().setMaxStrength(e),this.sgraph&&this.sgraph.selectedForConstraint(e)?this.needEvaluating[e]=!0:this.needEnforcing[e]=!0,this.variableUpdate()},t.prototype.variableIsOutput=function(t,e){e?this.outputVids[t.id]=!0:delete this.outputVids[t.id]},t.prototype.modelUpdate=function(){this.isUpdateNeeded=!0,this.solved.set(!1),1===this.updateOnModelChange?this.update():2===this.updateOnModelChange&&this.scheduleUpdate()},t.prototype.variableUpdate=function(){this.isUpdateNeeded=!0,this.solved.set(!1),1===this.updateOnVariableChange?this.update():2===this.updateOnVariableChange&&this.scheduleUpdate()},t.prototype.scheduleUpdate=function(){this.isUpdateScheduled||(this.isUpdateScheduled=!0,n.schedule(e.SystemUpdatePriority,this.performScheduledUpdate,this))},t.prototype.performScheduledUpdate=function(){this.isUpdateScheduled=!1,this.update()},t.prototype.update=function(){this.isUpdateNeeded&&(this.isUpdateNeeded=!1,this.plan(),this.evaluate(),0==this.pendingCount&&this.solved.set(!0))},t.prototype.plan=function(){var t=n.stringSet.members(this.needEnforcing);t.length>0&&(this.planner.plan(this.sgraph,t)&&(this.sgraph=this.planner.getSGraph(),this.topo=e.toposort(this.sgraph,this.planner),this.planner.setOptionals(n.reversemap(this.topo.vids,o.stayConstraint)),t.forEach(n.stringSet.add.bind(null,this.needEvaluating)),this.sgraph.variables().forEach(this.updateSourceStatus,this)),this.needEnforcing={})},t.prototype.updateSourceStatus=function(t){this.variables[t].source.set(this.sgraph.selectedForConstraint(o.stayConstraint(t))?!0:!1)},t.prototype.evaluate=function(){var t=n.stringSet.members(this.needEvaluating).map(function(t){return this.sgraph.selectedForConstraint(t)},this).filter(function(t){return!!t});if(t.length>0){var e=new o.DigraphWalker(this.sgraph.graph).nodesDownstreamSameType(t).filter(o.isNotStayMethod).reduce(n.stringSet.build,{}),r=this.topo.mids.filter(function(t){return e[t]});r.forEach(this.execute,this),this.needEvaluating={}}},t.prototype.execute=function(t){e.execute(this.methods[t],this.enable)},t.prototype.onNextEgraph=function(t){var e=n.stringSet.members(this.outputVids);if(e.length){var r=a.globalContributingCheck(this.sgraph,t,e);for(var i in this.variables){var o=this.variables[i];3===r[i]?(o.contributing.set(1),o.relevant.set(1)):2===r[i]?(o.contributing.set(2),o.relevant.set(2)):(o.contributing.set(0),o.relevant.set(a.relevancyCheck(this.cgraph,this.enable.egraph,this.outputVids,i)))}}},t}());e.ConstraintSystem=h}(e=t.system||(t.system={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){function n(t,e){for(var n=[],o={},s=t.inputs,a=0,h=s.length;h>a;++a)if(s[a]instanceof i.Variable){var u=s[a].id;if(!o[u]){var c=s[a].getPromise(),d=new r.Promise;r.plogger&&r.plogger.register(d,s[a].name,"input parameter"),d.resolve(c),c instanceof r.Promise&&d.ondropped.addObserver(c),o[u]=d}n.push(o[u])}else{var p=new r.Promise(s[a]);r.plogger&&r.plogger.register(p,s[a],"constant parameter"),n.push(p)}try{var l=t.fn.apply(null,n);if(1==t.outputs.length)l=[l];else{if(!Array.isArray(l))throw new TypeError("Multi-output method did not return array");l=l.slice(0)}for(var f=t.outputs,a=0,h=f.length;h>a;++a)f[a]instanceof i.Variable&&(r.plogger&&r.plogger.register(l[a],f[a].name,"output parameter"),f[a].makePromise(l[a]));e.methodScheduled(t.id,o,l)}catch(v){console.error(v)}}var r=t.reactive,i=t.model;e.execute=n}(e=t.system||(t.system={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){function n(t,e){var n=[],o=[],s=[],a=new r.Heap(function(t,n){return e.isStronger(i.stayConstraint(t),i.stayConstraint(n))}),h={};t.methods().forEach(function(e){var n=t.inputsForMethod(e).length;h[e]=n,0==n&&s.push(e)}),t.variables().forEach(function(e){var n=t.methodsWhichOutput(e).length;h[e]=n,0==n&&a.push(e)});for(var u=function(t){0==--h[t]&&s.push(t)},c=function(t){0==--h[t]&&a.push(t)};a.length>0||s.length>0;){for(;s.length>0;){var d=s.pop();n.push(d),t.outputsForMethod(d).forEach(c)}if(a.length>0){var p=a.pop();o.push(p),t.methodsWhichInput(p).forEach(u)}}return{vids:o,mids:n}}var r=t.utility,i=t.graph;e.toposort=n}(e=t.system||(t.system={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){function n(t,e){if("object"!=typeof t||!(t instanceof e))throw e.name+" required";return t}function r(t){return"object"==typeof t&&"function"==typeof t.onNext&&"function"==typeof t.onError&&"function"==typeof t.onCompleted}function i(t){return"object"==typeof t&&"function"==typeof t.addObserver&&"function"==typeof t.removeObserver}function o(t){return"object"==typeof t&&"function"==typeof t.onNext&&"function"==typeof t.onError&&"function"==typeof t.onCompleted&&"function"==typeof t.addObserver&&"function"==typeof t.removeObserver}function s(t){if(!t.model)throw"no model specified";if(!t.view)throw"no view specified";if(void 0===t.dir)if(i(t.model)&&r(t.view))t.dir=i(t.view)&&r(t.model)?0:2;else{if(!i(t.view)||!r(t.model))throw"unable to deduce binding direction";t.dir=1}else{if(1!=t.dir){if(!i(t.model))throw"model not observable";if(!r(t.view))throw"view not observer"}if(2!=t.dir){if(!i(t.view))throw"view not observable";if(!r(t.model))throw"model not observer"}}if(1!=t.dir&&t.toView)if(Array.isArray(t.toView)){var e=t.toView;if(!e.every(o))throw"toView contains invalid extension";t.toView=new f.Chain(e)}else if(!o(t.toView))throw"toView is not extension";if(2!=t.dir&&t.toModel)if(Array.isArray(t.toModel)){var e=t.toModel;if(!e.every(o))throw"toModel contains invalid extension";t.toModel=new f.Chain(e)}else if(!o(t.toModel))throw"toModel is not extension";return t}function a(t){var e=s(t);1!=e.dir&&(e.toView?(e.toView.addObserver(e.view),"function"==typeof e.model.addObserverInit?e.model.addObserverInit(e.toView):e.model.addObserver(e.toView)):"function"==typeof e.model.addObserverInit?e.model.addObserverInit(e.view):e.model.addObserver(e.view)),2!=e.dir&&(e.toModel?(e.view.addObserver(e.toModel),e.toModel.addObserver(e.model)):e.view.addObserver(e.model))}function h(t){var e=s(t);1!=e.dir&&(e.toView?(e.model.removeObserver(e.toView),e.toView.removeObserver(e.view)):e.model.removeObserver(e.view)),2!=e.dir&&(e.toModel?(e.view.removeObserver(e.toModel),e.toModel.removeObserver(e.model)):e.view.removeObserver(e.model))}function u(t,e){e?"string"==typeof e&&(e=document.getElementById(e)):e=document.body;var n=[];return e.nodeType===Node.ELEMENT_NODE?c(e,t,n):console.error("Invalid argument to performDeclaredBindings"),n}function c(t,e,n){var r=t.getAttribute("data-bind");r&&d(r,t,e,n);for(var i=0,o=t.childNodes.length;o>i;++i)t.childNodes[i].nodeType===Node.ELEMENT_NODE&&c(t.childNodes[i],e,n)}function d(t,e,n,r){var i=p(t);if(!i)return!0;try{var o=new Function(i),s=o.call(n),h=[];l(s,h)}catch(u){return console.error("Invalid binding declaration: "+JSON.stringify(t),u),!0}return h.forEach(function(t){t.view||"function"!=typeof t.mkview||(t.view=new t.mkview(e));try{a(t),r.push(t)}catch(n){console.error("Invalid binding for "+e,n)}}),!0}function p(t){return"with (this) {  return ["+t+"]}"}function l(t,e){for(var n=0,r=t.length;r>n;++n)Array.isArray(t[n])?l(t[n],e):e.push(t[n])}var f=t.reactive;!function(t){t[t.bi=0]="bi",t[t.v2m=1]="v2m",t[t.m2v=2]="m2v"}(e.Direction||(e.Direction={}));e.Direction;e.checkHtml=n,e.isObserver=r,e.isObservable=i,e.isExtension=o,e.bind=a,e.unbind=h,e.performDeclaredBindings=u}(e=t.bindings||(t.bindings={}))}(hd||(hd={}));var hd;!function(t){var e;!function(t){var e=function(){function e(e){this.el=t.checkHtml(e,HTMLElement)}return e.prototype.onNext=function(t){(void 0===t||null===t)&&(t="");for(var e=this.el;e.lastChild;)e.removeChild(e.lastChild);e.appendChild(document.createTextNode(t))},e.prototype.onError=function(){},e.prototype.onCompleted=function(){},e}();t.Text=e}(e=t.bindings||(t.bindings={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){var n=t.reactive,r=new Object,i=function(){function t(t,i){this.blurFrom=null,this.blurTo=null,this.initialized=!1,this.el=e.checkHtml(t,HTMLInputElement),this.stable=new n.Stabilizer(i,r);var o=this.update.bind(this);t.addEventListener("input",o),t.addEventListener("change",o),t.addEventListener("blur",this.onBlur.bind(this))}return t.prototype.addObserver=function(){this.stable.addObserver.apply(this.stable,arguments)},t.prototype.removeObserver=function(){this.stable.removeObserver.apply(this.stable,arguments)},t.prototype.update=function(){this.initialized=!0,this.stable.onNext(this.el.value)},t.prototype.onNext=function(t){void 0===t||null===t?t="":"string"!=typeof t&&(t=t.toString()),this.initialized&&this.el===document.activeElement?(this.blurFrom=this.el.value,this.blurTo=t):(this.el.value!=t&&(this.el.value=t,this.el===document.activeElement&&this.el.select()),this.blurFrom=this.blurTo=null)},t.prototype.onBlur=function(){this.blurFrom===this.el.value&&this.el.value!=this.blurTo&&(this.el.value=this.blurTo),this.blurFrom=this.blurTo=null,this.initialized=!1,this.stable.onNext(r)},t.prototype.onError=function(){},t.prototype.onCompleted=function(){},t}();e.Edit=i}(e=t.bindings||(t.bindings={}))}(hd||(hd={}));var hd;!function(t){var e;!function(t){var e=function(){function t(t,e,n){this.el=n,this.trueClass=t,this.falseClass=e}return t.prototype.onNext=function(t){t?(this.falseClass&&this.el.classList.remove(this.falseClass),this.trueClass&&this.el.classList.add(this.trueClass)):(this.trueClass&&this.el.classList.remove(this.trueClass),this.falseClass&&this.el.classList.add(this.falseClass))},t.prototype.onError=function(){},t.prototype.onCompleted=function(){},t}();t.CssClass=e}(e=t.bindings||(t.bindings={}))}(hd||(hd={}));var __extends=this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);n.prototype=e.prototype,t.prototype=new n},hd;!function(t){var e;!function(e){var n=t.reactive.BasicObservable,r=(function(){function t(t){this.el=t}return t.prototype.onNext=function(t){for(var e=this.el;e.lastChild;)e.removeChild(e.lastChild);t.forEach(function(t){var n=document.createElement("option");n.value=t.id,n.text=t.label?t.label:t.id,e.appendChild(n)});var n=document.createEvent("HTMLEvents");n.initEvent("change",!1,!0),this.el.dispatchEvent(n)},t.prototype.onError=function(){},t.prototype.onCompleted=function(){},t}(),function(t){function n(n){if(t.call(this),this.el=e.checkHtml(n,HTMLElement),n){var r=this.update.bind(this);n.addEventListener("input",r),n.addEventListener("change",r)}}return __extends(n,t),n.prototype.update=function(){this.sendNext(this.el.value)},n.prototype.onNext=function(t){t&&(this.el.value=t)},n.prototype.onError=function(){},n.prototype.onCompleted=function(){},n}(n));e.Value=r}(e=t.bindings||(t.bindings={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){var n=t.reactive,r=function(t){function n(n){t.call(this),this.el=e.checkHtml(n,HTMLInputElement);var r=this.update.bind(this);n.addEventListener("input",r),n.addEventListener("change",r)}return __extends(n,t),n.prototype.update=function(){this.sendNext(this.el.checked)},n.prototype.onNext=function(t){this.el.checked=!!t},n.prototype.onError=function(){},n.prototype.onCompleted=function(){},n}(n.BasicObservable);e.Checked=r}(e=t.bindings||(t.bindings={}))}(hd||(hd={}));var hd;!function(t){var e;!function(t){var e=function(){function e(e){this.el=t.checkHtml(e,HTMLElement)}return e.prototype.onNext=function(t){this.el.disabled=t?!1:!0},e.prototype.onError=function(){},e.prototype.onCompleted=function(){},e}();t.Enabled=e}(e=t.bindings||(t.bindings={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){function n(){return o||(o=new i),o}var r=t.reactive,i=function(t){function e(){t.call(this);var e=this;document.addEventListener("mousemove",function(t){e.sendNext({x:t.clientX,y:t.clientY})})}return __extends(e,t),e}(r.BasicObservable);e.MousePosition=i;var o;e.getMousePosition=n}(e=t.bindings||(t.bindings={}))}(hd||(hd={}));var hd;!function(t){var e;!function(t){var e=function(){function e(e){this.el=t.checkHtml(e,HTMLElement),e.style.position="absolute"}return e.prototype.onNext=function(t){this.el.style.left=t.x+"px",this.el.style.top=t.y+"px"},e.prototype.onError=function(){},e.prototype.onCompleted=function(){},e}();t.Position=e}(e=t.bindings||(t.bindings={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){var n=t.reactive,r=function(t){function n(n,r){t.call(this),this.el=e.checkHtml(r,HTMLElement),this.value=n,r.addEventListener("click",this.update.bind(this))}return __extends(n,t),n.prototype.update=function(){this.sendNext(this.value)},n}(n.BasicObservable);e.Clicked=r}(e=t.bindings||(t.bindings={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){var n=t.reactive,r=function(t){function e(e){t.call(this),window.setInterval(this.update.bind(this),e)}return __extends(e,t),e.prototype.update=function(){this.sendNext(new Date)},e}(n.BasicObservable);e.Time=r}(e=t.bindings||(t.bindings={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){function n(){if(0!=arguments.length){if(1==arguments.length){var t=arguments[0];if(Array.isArray(t)){if(!t.every(e.isExtension))throw"Invalid extension passed to chain";return new k.Chain(t)}return t}for(var n=[],r=0,i=arguments.length;i>r;++r){var t=arguments[r];if(Array.isArray(t)){if(!t.every(e.isExtension))throw"Invalid extension passed to chain";Array.prototype.push.apply(n,t)}else if(t){if(!e.isExtension(t))throw"Invalid extension passed to chain";n.push(t)}}return n.length>0?new k.Chain(n):void 0}}function r(t,e){var n=e.split(".");return new k.HotSwap(new T.Path(t,n))}function i(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];return new k.FunctionExtension(t,e)}function o(t){return new k.Delay(t)}function s(t,e){return new k.Stabilizer(t,e)}function a(t){return new k.ReplaceError(t)}function h(){return new k.Required}function u(t){return new k.Default(t)}function c(t){return new k.Round(t)}function d(t){return new k.NumberToFixed(t)}function p(t){return new k.NumberToPrecision(t)}function l(t){return new k.NumberToExponential(t)}function f(t){return new k.ScaleNumber(t)}function v(){return new k.ToString}function g(){return new k.ToJson}function m(){return new k.ToDate}function y(){return new k.DateToString}function b(){return new k.DateToDateString}function x(){return new k.DateToTimeString}function w(){return new k.DateToMilliseconds}function C(){return new k.MillisecondsToDate}function O(){return new k.ToNumber}function E(t,e){return new k.Offset(t,e)}function N(){return new k.PointToString}var k=t.reactive,T=t.model;e.chain=n,e.path=r,e.fn=i,e.delay=o,e.stabilize=s,e.msg=a,e.req=h,e.def=u,e.round=c,e.fix=d,e.prec=p,e.exp=l,e.scale=f,e.toStr=v,e.toJson=g,e.toDate=m,e.dateToString=y,e.dateToDateString=b,e.dateToTimeString=x,e.dateToMilliseconds=w,e.millisecondsToDate=C,e.toNum=O,e.offset=E,e.pointToString=N}(e=t.bindings||(t.bindings={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){function n(t,e){return t?e?Array.isArray(t)?t.concat(Array.isArray(e)?e:[e]):Array.isArray(e)?[t].concat(e):[t,e]:t:e}function r(t,n,r){return{mkview:e.Edit,model:t,dir:0,toView:n,toModel:r}}function i(t,e,n){return[r(t,e,n),c(t),d(t.relevant)]}function o(t,r,i,o){return void 0===r||null===r?{mkview:e.Edit,model:t,dir:0,toView:i,toModel:n(new g.ToNumber,o)}:{mkview:e.Edit,model:t,dir:0,toView:n(i,r>=0?new g.NumberToFixed(r):new g.Round(r)),toModel:n([new g.ToNumber,new g.Round(r)],o)}}function s(t,e,n,r){return[o(t,e,n,r),c(t),d(t.relevant)]}function a(t,r,i){return{mkview:e.Edit,model:t,dir:0,toView:n(r,new g.DateToDateString),toModel:n(new g.ToDate,i)}}function h(t,e,n){return[a(t,e,n),c(t),d(t.relevant)]}function u(t,n){return{mkview:e.Text,model:t,toView:n,dir:2}}function c(t,n,r,i){if(!n&&!r&&t instanceof m.Variable){var o=t;return[{mkview:e.CssClass.bind(null,"source","derived"),model:o.source,dir:2},{mkview:e.CssClass.bind(null,"pending","complete"),model:o.pending,dir:2},{mkview:e.CssClass.bind(null,"contributing","noncontributing"),model:o.contributing,dir:2},{mkview:e.CssClass.bind(null,"error",null),model:o.error,dir:2}]}return[{mkview:e.CssClass.bind(null,n,r),model:t,dir:2,toView:i}]}function d(t,n){return{mkview:e.Enabled,model:t,dir:2,toView:n}}function p(t,n,r){return{mkview:e.Value,model:t,dir:0,toView:n,toModel:r}}function l(t,n,r){return{mkview:e.Checked,model:t,dir:0,toView:n,toModel:r}}function f(t,n){return{mkview:e.Clicked.bind(null,!0),model:t,dir:1,toModel:n}}function v(t,n){return{mkview:e.Position,model:t,dir:2,toView:n}}var g=t.reactive,m=t.model;e.edit=r,e.editVar=i,e.num=o,e.numVar=s,e.date=a,e.dateVar=h,e.text=u,e.cssClass=c,e.enabled=d,e.value=p,e.checked=l,e.clicked=f,e.position=v}(e=t.bindings||(t.bindings={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){function n(t){return!t.hasDependencies()}function r(t,n){var r=e.workerPools[t];r?r.max=n:e.workerPools[t]=new s(t,n)}function i(t,n,r){return void 0===r&&(r=1),e.workerPools[t]||(e.workerPools[t]=new s(t)),function(){var i=e.workerPools[t],o=i.schedule(n,Array.prototype.slice.call(arguments,0,arguments.length),r);return 1==r?o[0]:o}}var o=t.reactive,s=function(){function t(t,e){void 0===e&&(e=20),this.availableWorkers=[],this.runningTasks=[],this.queuedTasks=[],this.sourceUrl=t,this.max=e}return t.prototype.schedule=function(t,e,n){void 0===n&&(n=1);for(var r=[],i=0;n>i;++i)r.push(new o.Promise);var s={fnName:t,inputs:e,outputs:r};return r.forEach(function(t){t.ondropped.addObserver(this,this.onPromiseDropped,null,null,s)},this),this.queuedTasks.push(s),this.checkQueue(),r},t.prototype.checkQueue=function(){for(;this.queuedTasks.length>0&&this.availableWorkers.length>0;)this.execute(this.queuedTasks.shift(),this.availableWorkers.shift());for(;this.queuedTasks.length>0&&this.runningTasks.length<this.max;){var t=this.queuedTasks.shift();try{this.execute(t,new Worker(this.sourceUrl))}catch(e){console.error("Unable to create worker",e),t.outputs.forEach(function(t){t.reject("Script unable to create worker")})}}},t.prototype.execute=function(t,e){t.worker=e,this.runningTasks.push(t),e.onmessage=this.onMessage.bind(this,t),e.onerror=this.onError.bind(this,t),e.postMessage({fnName:t.fnName,inputs:t.inputs})},t.prototype.onMessage=function(t,e){if(e.data.error)console.warn("Task failed: "+JSON.stringify(e.data.error)),t.outputs.forEach(function(t){t.reject(e.data.error)}),this.returnWorker(t.worker);else if(e.data.complete){var n=e.data.result;if(1==t.outputs.length)t.outputs[0].resolve(n);else for(var r=0,i=t.outputs.length;i>r;++r)t.outputs[r].resolve(n[r]);this.returnWorker(t.worker)}else{var n=e.data.result;if(1==t.outputs.length)t.outputs[0].notify(n);else for(var r=0,i=t.outputs.length;i>r;++r)t.outputs[r].notify(n[r])}},t.prototype.onError=function(t,e){console.warn("Worker failed: "+JSON.stringify(e.data)),t.outputs.forEach(function(t){t.reject(e.data)
}),this.killWorker(t.worker)},t.prototype.returnWorker=function(t){if(this.runningTasks.length>=this.max)this.killWorker(t);else if(this.queuedTasks.length>0)this.execute(this.queuedTasks.shift(),t);else{var e=this.findTaskIndexFor(t);e>=0&&(this.runningTasks.splice(e,1),t.onmessage=null,t.onerror=null,this.availableWorkers.push(t))}},t.prototype.killWorker=function(t){var e=this.findTaskIndexFor(t);e>=0&&this.runningTasks.splice(e,1),t.terminate(),this.checkQueue()},t.prototype.onPromiseDropped=function(t,e){e.outputs.every(n)&&(e.worker?this.killWorker(e.worker):this.dequeue(e))},t.prototype.dequeue=function(t){var e=this.queuedTasks.indexOf(t);e>=0&&this.queuedTasks.splice(e,1)},t.prototype.findTaskIndexFor=function(t){for(var e=0,n=this.runningTasks.length;n>e;++e)if(this.runningTasks[e].worker===t)return e;return-1},t}();e.WorkerPool=s,e.workerPools={},e.setMaxWorkers=r,e.worker=i}(e=t.async||(t.async={}))}(hd||(hd={}));var hd;!function(t){t.setMaxWorkers=t.async.setMaxWorkers,t.worker=t.async.worker}(hd||(hd={}));var hd;!function(t){var e;!function(e){function n(t){var e=[];for(var n in t)e.push(n+"="+encodeURIComponent(t[n]));return e.join("&")}function r(t,e){e&&(t+="?"+n(e));var r=new XMLHttpRequest,i=new a.Promise;return r.addEventListener("readystatechange",function(){4==r.readyState&&(200==r.status?i.resolve(r):i.reject(r.statusText))}),r.open("GET",t),r.send(),i}function i(t,e){return r(t,e).then(function(t){return t.responseXML})}function o(t,e){return r(t,e).then(function(t){return t.responseText})}function s(t,e){return r(t,e).then(function(t){return JSON.parse(t.responseText)})}var a=t.reactive;e.ajax=r,e.ajaxXML=i,e.ajaxText=o,e.ajaxJSON=s}(e=t.async||(t.async={}))}(hd||(hd={}));var hd;!function(t){t.ajax=t.async.ajax,t.ajaxXML=t.async.ajaxXML,t.ajaxText=t.async.ajaxText,t.ajaxJSON=t.async.ajaxJSON}(hd||(hd={}));var hd;!function(t){function e(t){t.usage.set(1)}function n(t){t.usage.set(2)}function r(t){t.usage.set(3)}var i=t.utility,o=t.reactive,s=t.plan,a=t.model,h=t.system,u=t.bindings;t.defaultPlannerType=s.QuickPlanner,t.markUsed=e,t.markUnused=n,t.markDelayed=r,t.dateCompare=i.dateCompare,t.ProxyObserver=o.ProxyObserver,t.BasicObservable=o.BasicObservable,t.Promise=o.Promise,t.Extension=o.Extension,t.liftFunction=o.liftFunction,t.dir=u.Direction,t.bind=u.bind,t.unbind=u.unbind,t.performDeclaredBindings=u.performDeclaredBindings,t.isObservable=u.isObservable,t.isObserver=u.isObserver,t.isExtension=u.isExtension,t.ConstraintSystem=h.ConstraintSystem,t.ModelBuilder=a.ModelBuilder,t.Checked=u.Checked,t.Clicked=u.Clicked,t.CssClass=u.CssClass,t.Edit=u.Edit,t.Enabled=u.Enabled,t.MousePosition=u.MousePosition,t.Position=u.Position,t.Text=u.Text,t.Time=u.Time,t.Value=u.Value,t.checked=u.checked,t.clicked=u.clicked,t.cssClass=u.cssClass,t.edit=u.edit,t.editVar=u.editVar,t.date=u.date,t.dateVar=u.dateVar,t.enabled=u.enabled,t.mousePosition=u.getMousePosition,t.num=u.num,t.numVar=u.numVar,t.position=u.position,t.text=u.text,t.value=u.value,t.chain=u.chain,t.dateToMilliseconds=u.dateToMilliseconds,t.dateToDateString=u.dateToDateString,t.dateToString=u.dateToString,t.dateToTimeString=u.dateToTimeString,t.def=u.def,t.delay=u.delay,t.exp=u.exp,t.fix=u.fix,t.fn=u.fn,t.millisecondsToDate=u.millisecondsToDate,t.msg=u.msg,t.offset=u.offset,t.path=u.path,t.pointToString=u.pointToString,t.prec=u.prec,t.req=u.req,t.round=u.round,t.scale=u.scale,t.stabilize=u.stabilize,t.toDate=u.toDate,t.toJson=u.toJson,t.toNum=u.toNum,t.toStr=u.toStr}(hd||(hd={}));