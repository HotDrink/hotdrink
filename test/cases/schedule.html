<html>
  <head>
    <title>HotDrink Test</title>
    <script type="text/javascript" src="../../scripts/hotdrink.js"></script>
    <script type="text/javascript">
    {
      function plus1( n ) {
        return n + 1;
      }

      function gt1( n ) {
        return n > 1;
      }

      function toTime( n ) {
        var sign = 1;
        if (n < 0) {
          sign = -1;
          n = -n;
        }

        var hours = Math.floor( n / 60 );
        var minutes = Math.floor( n % 60 );

        if (sign < 0) {
          hours = -hours;
          if (minutes > 0) {
            --hours;
            minutes = 60 - minutes;
          }
        }

        hours += 9;

        return hours + ':' + (minutes < 10 ? '0' + minutes : minutes);
      }

      function fromTime( t ) {
        var m = t.match( /^(\d+)(?:\:(\d+)?)?$/ );
        if (!m) {
          throw "Invalid time";
        }

        var hours = Number( m[1] );
        var minutes = Number( m[2] || 0 );
        if (minutes > 60) {
          throw "Invalid minutes";
        }

        return (hours - 9)*60 + minutes;
      }

      hd.config.forwardPriorGens = true;

      // var EventSpec = new hd.ContextBuilder()
      //     .variables( "title, begin, end, length", {length: 10} )
      //     .constraint( "begin, end, length" )
      //       .method( "begin, length -> end", hd.sum )
      //       .method( "end, length -> begin", hd.diff )
      //     .spec();

      var EventSpec = new hd.ContextBuilder()
          .variables( "title, begin, begin1, end, end1, length", {length: 10} )
          .touchDep( "begin => begin1" )
          .touchDep( "end => end1" )
          .constraint( "begin, begin1, end, end1, length" )
          .method( "end, !begin -> length, begin",
                   function( end, begin ) {
                     if (end - 10 >= begin) {
                       return [end - begin, begin];
                     }
                     else {
                       return [10, end - 10]
                     }
                   } )
          .method( "!end, begin -> length, end",
                   function( end, begin ) {
                     if (end >= begin + 10) {
                       return [end - begin, end];
                     }
                     else {
                       return [10, begin + 10];
                     }
                   } )
          .method( "end, length -> begin, begin1",
                   function( end, length ) {
                     return [end - length, 0];
                   } )
          .method( "begin, length -> end, end1",
                   function( begin, length ) {
                     return [begin + length, 0]
                   } )
          .spec();


      var schedule = new hd.ContextBuilder()
          .nested( "events", hd.ArrayContext.bind( null, null, EventSpec ) )
          .constraint( "events[i].end, events[i+1].begin" )
            .method( "events[i].end, !events[i+1].begin -> events[i+1].begin", hd.max )
            .method( "!events[i].end, events[i+1].begin -> events[i].end", hd.min )
          .constant( 'remove', function( i ) {
            if (i < this.events.length) {
              this.events.collapse( 1, i );
              pm.update();
            }
          } )
          .context();

      schedule.events.expand( [{title: "Do something", begin: 0, length: 30},
                               {title: "Do something else", begin: 40, length: 60},
                               {title: "Do nothing", begin: 60, length: 90}] );

      pm = new hd.PropertyModel();
      pm.addComponent( schedule );
      pm.update();

      function addEvent() {
        schedule.events.expand( 1 );
        pm.update();
      }

      window.addEventListener( "load", function() {
        hd.performDeclaredBindings( schedule );
      } )
    }
    </script>
    <style type="text/css">
      input.title { width: 30ex; }
      input.num   { width: 8ex; text-align: right; }
      .error, .stale { color: #900; }
      div.event { margin: 1em; }
      th { font-weight: normal; text-decoration: underline; }
      a.control { text-decoration: none; }
      td:first-child { padding-right: 1em; }
      td:last-child { padding-left: 1em; font-size: 70%; vertical-align: middle }
    </style>
  </head>
  <body>
    <table>
      <thead>
        <tr>
          <th></th>
          <th>Title</th>
          <th>Begin</th>
          <th>End</th>
          <th>Duration</th>
        </tr>
      </thead>
      <tbody data-bind="hd.forEach( 'e', events, 'idx' )">
        <tr>
          <td>
            <span data-bind="hd.text( $idx, hd.fn( plus1 ) )"></span>
          </td>
          <td>
            <input type="text" class="title" placeholder="Enter event title"
                   data-bind="hd.editVar( e.title )"/>
          </td>
          <td>
            <input type="text" class="num"
                   data-bind="hd.editVar( e.begin, hd.fn( toTime ), hd.fn( fromTime ) )"/>
          </td>
          <td>
            <input type="text" class="num"
                   data-bind="hd.editVar( e.end, hd.fn( toTime ), hd.fn( fromTime ) )"/>
          </td>
          <td>
            <input type="text" class="num" data-bind="hd.numVar( e.length, 0 )"/><small style="margin-left: 0.2ex">min</small>
          </td>
          <td>
            <span data-bind="hd.when( events.$length, hd.fn( gt1 ) )"</span>
            [<a class="control" href="#" onclick="return false;"
                data-bind="hd.clicked( hd.fn( this, remove, idx ) )">X</a>]
          </td>
        </tr>
      </tbody>
      <tfoot>
        <td></td>
        <td colspan="4">
          <input type="button" value="Add Event"
                 data-bind="hd.clicked( hd.fn( addEvent ) )"/>
        </td>
        <td></td>
      </tfoot>
    </table>
  </body>
</html>
