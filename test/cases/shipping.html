<html>
  <head>
    <title>HotDrink Test</title>
    <style type="text/css">
      .pending { background: left center no-repeat #eee url(spinner.gif); }
      .stale { background: #fee; }
      .error   { color: #905; }
      input[type="text"] { width: 6em; text-align: right; margin-right: 1px; }
      td { padding: 0 }
      td.dim input[type="text"] { width: 4em; }
      fieldset { border-radius: 1ex; display: inline-block  }
      fieldset td { font-size: 80% }
      fieldset input[type="text"] { font-size: 80% }
      td.padr { padding-right: 2em; }
      small { font-size: 70% }
      input[type="button"] { display: block; }
    </style>
    <script type="text/javascript" src="../../scripts/hotdrink.js"></script>
    <script type="text/javascript">
    {
      var q = [];

      function delay( v, n ) {
        var p = new hd.Promise();

        var b = document.createElement( 'input' );
        b.type = 'button';
        b.value = n;
        b.onclick = function() {
          p.resolve( v );
          document.getElementById( 'buttons' ).removeChild( b );
        }
        var bs= document.getElementById( 'buttons' ).appendChild( b );
        return p;
      }

      function next() {
        if (q.length) {
          var f = q.shift();
          f();
        }
      }

      var context = new hd.ContextBuilder()

          .vs( 'distance, klass, target, price, volume, weight, width, height, depth',
               {distance: 1500, width: 25, height: 50, depth: 40, weight: 10}
             )

          .c( 'distance, klass, target, price' )
          .m( 'distance, klass -> target, price', function( distance, klass ) {
            var perkm;
            switch (klass) {
            case 'A': perkm = 0.01;
                      break;
            case 'B': perkm = 0.02;
                      break;
            case 'C': perkm = 0.035;
                      break;
            case 'D': perkm = 0.06;
                      break;
            default:  perkm = 0.1;
                      break;
            }
            return [delay(distance*perkm, 'target'), delay(distance*perkm, 'price')];
          } )
          .m( 'target, klass -> distance, price', function( target, klass ) {
            var perkm;
            switch (klass) {
            case 'A': perkm = 0.01;
                      break;
            case 'B': perkm = 0.02;
                      break;
            case 'C': perkm = 0.035;
                      break;
            case 'D': perkm = 0.06;
                      break;
            default:  perkm = 0.1;
                      break;
            }
            var distance = Math.floor( target/perkm );
            return [delay(distance, 'distance'), delay(distance*perkm, 'price')];
          } )
          .m( 'target, distance -> klass, price', function( target, distance ) {
            var perkm = target / distance;
            var klass;
            if (perkm >= 0.1) {
              perkm = 0.1;
              klass = 'E';
            }
            else if (perkm >= 0.06) {
              perkm = 0.06;
              klass = 'D';
            }
            else if (perkm >= 0.035) {
              perkm = 0.035;
              klass = 'C';
            }
            else if (perkm >= 0.02) {
              perkm = 0.02;
              klass = 'B';
            }
            else {
              perkm = 0.01;
              klass = 'A';
            }

            return [delay(klass, 'class'), delay(distance*perkm, 'price')];
          } )

          .c( 'volume, weight, klass' )
          .m( 'volume, weight -> klass', function( volume, weight ) {
            var vw = volume / 0.025;
            if (weight < vw) weight = vw;

            var klass;
            if (weight <= 1)         klass = 'A';
            else if (weight <= 10)   klass = 'B';
            else if (weight <= 25)   klass = 'C';
            else if (weight <= 50)   klass = 'D';
            else                     klass = 'E';
            return delay( klass, 'class' );
          } )
          .m( 'klass -> volume, weight', function( klass ) {
            var weight;
            switch (klass) {
            case 'A': weight = 1;   break;
            case 'B': weight = 10;  break;
            case 'C': weight = 25;  break;
            case 'D': weight = 50;  break;
            default:  weight = 100; break;
            }
            return [delay(weight * 0.025, 'volume'), delay(weight, 'weight')];
          } )

      .eq( 'width*height*depth == volume*1000000' )
          // .c( 'width, height, depth, volume' )
          // .m( 'width, height, depth -> volume',
          //     function( width, height, depth ) {
          //       return width * height * depth / 1000000;
          //     }
          //   )
          // .m( '!width, !height, !depth, volume -> width, height, depth',
          //     function( width, height, depth, volume ) {
          //       var r = Math.cbrt( volume / (width*height*depth) ) * 100;
          //       return [r*width, r*height, r*depth];
          //     }
          //   )

          .context();

      var pm = new hd.PropertyModel();
      pm.addComponent( context );

      window.addEventListener( 'load', function() {
        hd.performDeclaredBindings( context );
      } );

    }
    </script>
  </head>
  <body>
    <fieldset>
      <legend><b>Class:</b>
        <!-- <img style="vertical-align:text-bottom" -->
        <!--      data-bind="hd.visible( klass, hd.not() )" -->
        <!--      src="spinner.gif"/> -->
        <select data-bind="hd.value( klass ),hd.cssClass( klass )">
          <option value="A">&nbsp; &nbsp; A</option>
          <option value="B">&nbsp; &nbsp; B</option>
          <option value="C">&nbsp; &nbsp; C</option>
          <option value="D">&nbsp; &nbsp; D</option>
          <option value="E">&nbsp; &nbsp; E</option>
        </select>
      </legend>
      <table style="border-spacing: 0 1ex; margin: -1ex 0">
        <tr>
          <td>Volume:</td>
          <td class="padr" style="text-align:right">
            <input type="text"
                   data-bind="hd.numVar(volume)"/><small>m<sup>3</sup></small>
          </td>
          <td>Weight:</td>
          <td style="text-align:right">
            <input type="text"
                   data-bind="hd.numVar(weight)"/><small>kg</small>
          </td>
        </tr>
        <tr>
          <td style="text-align:center" class="dim" colspan="4">
            Dimensions:
            <input type="text" data-bind="hd.numVar(width)"/>
            <small>cm</small> &times;
            <input type="text" data-bind="hd.numVar(height)"/><small>cm</small> &times;
            <input type="text" data-bind="hd.numVar(depth)"/><small>cm</small>
          </td>
        </tr>
      </table>
    </fieldset>
    <table style="margin-left:1em;border-spacing: 0 0.5em">
      <tr>
        <td><b>Distance:</b></td>
        <td></td>
        <td><input type="text" data-bind="hd.numVar( distance, 0 )"/><small>km</small></td>
      </tr>
      <tr>
        <td><b>Price:</b></td>
        <td>$</td>
        <td><input type="text" data-bind="hd.num( hd.rw( price, target ), 2 ),
                                          hd.cssClass( price )"/><small style="font-variant: small-caps;">usd</small></td>
      </tr>
    </table>
    <br/><br/><br/><br/><br/><br/><br/><br/><br/><br/>
    <fieldset>
      <legend>Distance Calculator</legend>
      <table>
        <tr>
          <td>Leaving from:</td>
          <td>
            <select style="width:32ex">
              <option>Houston, TX</option>
            </select>
          </td>
        </tr><tr>
          <td style="text-align:right">Arriving in:</td>
          <td>
            <select style="width:32ex">
              <option>Seattle, WA</option>
            </select>
          </td>
        </tr>
        <tr>
          <td colspan="2" style="height: 0.6em"></td>
        </tr>
        <tr>
          <td colspan="2" align="right">
            <input type="button" value="Calculate"/>
          </td>
        </tr>
      </table>
    </fieldset>
    <br/><br/><br/><br/><br/><br/><br/><br/><br/><br/>
    <div id="buttons"></div>
  </body>
</html>
