<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
               "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Hotdrink: Programmer's Guide</title>
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1"/>
<meta name="title" content="Hotdrink: Programmer's Guide"/>
<meta name="generator" content="Org-mode"/>
<meta name="generated" content="2012-05-04 16:52:15 "/>
<meta name="author" content=""/>
<meta name="description" content=""/>
<meta name="keywords" content=""/>
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  html { font-family: Times, serif; font-size: 12pt; }
  .title  { text-align: center; }
  .todo   { color: red; }
  .done   { color: green; }
  .tag    { background-color: #add8e6; font-weight:normal }
  .target { }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  {margin-left:auto; margin-right:0px;  text-align:right;}
  .left   {margin-left:0px;  margin-right:auto; text-align:left;}
  .center {margin-left:auto; margin-right:auto; text-align:center;}
  p.verse { margin-left: 3% }
  pre {
	border: 1pt solid #AEBDCC;
	background-color: #F3F5F7;
	padding: 5pt;
	font-family: courier, monospace;
        font-size: 90%;
        overflow:auto;
  }
  table { border-collapse: collapse; }
  td, th { vertical-align: top;  }
  th.right  { text-align:center;  }
  th.left   { text-align:center;   }
  th.center { text-align:center; }
  td.right  { text-align:right;  }
  td.left   { text-align:left;   }
  td.center { text-align:center; }
  dt { font-weight: bold; }
  div.figure { padding: 0.5em; }
  div.figure p { text-align: center; }
  div.inlinetask {
    padding:10px;
    border:2px solid gray;
    margin:10px;
    background: #ffffcc;
  }
  textarea { overflow-x: auto; }
  .linenr { font-size:smaller }
  .code-highlighted {background-color:#ffff00;}
  .org-info-js_info-navigation { border-style:none; }
  #org-info-js_console-label { font-size:10px; font-weight:bold;
                               white-space:nowrap; }
  .org-info-js_search-highlight {background-color:#ffff00; color:#000000;
                                 font-weight:bold; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="stylesheet.css" />

<script type="text/javascript">
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>

</head>
<body>

<div id="preamble">

</div>

<div id="content">
<h1 class="title">Hotdrink: Programmer's Guide</h1>






<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1 In a nutshell</a></li>
<li><a href="#sec-2">2 Introduction</a>
<ul>
<li><a href="#sec-2-1">2.1 Property model</a></li>
<li><a href="#sec-2-2">2.2 View and bindings</a></li>
</ul>
</li>
<li><a href="#sec-3">3 Helper functions for manipulating dates</a></li>
<li><a href="#sec-4">4 Dependencies</a></li>
<li><a href="#sec-5">5 Tutorial style sheet</a></li>
</ul>
</div>
</div>

<div id="outline-container-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> In a nutshell</h2>
<div class="outline-text-2" id="text-1">


<p>
Hotdrink is Javascript library for programming graphical user
interfaces.  The library is declarative: the programmer specifies a
<i>model</i> of the data to be manipulated through a user interface (UI) as
a <i>constraint system</i>, and binds a <i>view</i>, set of GUI widgets, to the
model.  These two specifications fully determine the behavior of the
user interface.  Typical applications of property models are dialog
windows and forms.
</p>
</div>

</div>

<div id="outline-container-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Introduction</h2>
<div class="outline-text-2" id="text-2">


<p>
To introduce Hotdrink, we show an implementation of a simple dialog
for selecting the dates for, say, a hotel stay:
</p>



<script type="text/javascript" src="https://raw.github.com/kriskowal/es5-shim/master/es5-shim.min.js"></script>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script type="text/javascript" src="../../hotdrink.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
<script type="text/javascript" src="http://code.jquery.com/ui/1.8.18/jquery-ui.min.js"></script>
<link type="text/css" href="http://code.jquery.com/ui/1.8.18/themes/base/jquery-ui.css" rel="Stylesheet" />


<script type="text/javascript">

function dateToString (d) { return {value: $.datepicker.formatDate('mm/dd/yy', d)}; }
function stringToDate (s) {
  var d= Date.parse(s);
  if (isNaN(d))
    return {error: "Invalid date format"};
  else
    return {value: new Date(d)};
}

function add_days(d, n) {
  var d2 = new Date(d.getTime());
  d2.setDate(d.getDate() + n);
  return d2;
}

function remove_days(d, n) {
  var d2 = new Date(d.getTime());
  d2.setDate(d.getDate() - n);
  return d2;
}

// 1 day in milliseconds
var one_day=1000*60*60*24;

function day_difference(d1, d2) {
  // Calculate the difference in milliseconds
  var difference_ms = d2.getTime() - d1.getTime();
    
  // Convert back to days and return
  return Math.round(difference_ms / one_day).toString(); 
}

// Associate datepicker with the check_in and check_out fiels,
// and trigger a keyup event when a date is picked
$(function() { 
  $( "#check_in" ).datepicker({
      onSelect: function() { $(this).keyup(); }
  });
  $( "#check_out" ).datepicker({
      onSelect: function() { $(this).keyup(); }
  });
});
</script>


<script type="text/javascript">

  var DateModel = function () {
    this.check_in = hd.variable(new Date());
    this.nights = hd.variable(2);
    this.check_out = hd.variable();

    hd.constraint()
      .method(this.check_out, function () { return add_days(this.check_in(), this.nights()); })
      .method(this.check_in, function () { return remove_days(this.check_out(), this.nights()); })
      .method(this.nights, function () { return day_difference(this.check_in(), this.check_out()); });
  };
  
  var model = hd.model(new DateModel());
  
  $(document).ready(function () {
    hotdrink.bind(model);
  });
</script>

<fieldset>
  <legend>Select dates</legend>
  <div>
    <label>Check in</label>
    <input id="check_in" type="text" data-bind="text: {value: check_in, convert: stringToDate, convertBack: dateToString}" />
  </div>
  <div>
    <label>Check out</label>
    <input id="check_out" type="text" data-bind="text: {value: check_out, convert: stringToDate, convertBack: dateToString}" />
  </div>
  <div>
    <label>Nights</label>
    <input type="text" data-bind="number: nights" />
  </div>
</fieldset>


<p>
The three text boxes in this dialog are related. Updating any one of them 
causes a change in one of the other two. For example, increasing the
number of nights will either move the end date forward or the start 
date backward. The field to change is the one <i>least recently edited</i> by the user.
</p>
<p>
Three specifications realize this dialog: (1) 
the <i>view</i>, code that defines the widgets and their placement in the
dialog window; (2) the <i>property model</i>, code that describes the constraint system
that maintains the data that is viewed and manipulated through the view's widgets; 
and (3) the <i>bindings</i> between the view and the model.
The layout (1) is specified using HTML; the property model (2) is specified
in Javascirpt, using a little <i>domain-specific language</i> embedded in Javascript;
and (3) is mostly embedded in the view specification.
</p>

</div>

<div id="outline-container-2-1" class="outline-3">
<h3 id="sec-2-1"><span class="section-number-3">2.1</span> Property model</h3>
<div class="outline-text-3" id="text-2-1">


<p>
The property model is built up using the HotDrink API.  This JavaScript code
must be placed in the document and executed once the document has finished
loading.  (In this example we are using jQuery's <code>document.ready</code> event to
accomplish this.)  For completeness, the Javascript helper functions are shown
in FIXME.
</p>



<pre class="src src-javascript">&lt;script type=<span style="color: #a0522d;">"text/javascript"</span>&gt;

  <span style="color: #a020f0;">var</span> <span style="color: #daa520;">DateModel</span> = <span style="color: #a020f0;">function</span> () {
    <span style="color: #008b8b;">this</span>.check_in = hd.variable(<span style="color: #a020f0;">new</span> <span style="color: #228b22;">Date</span>());
    <span style="color: #008b8b;">this</span>.nights = hd.variable(2);
    <span style="color: #008b8b;">this</span>.check_out = hd.variable();

    hd.constraint()
      .method(<span style="color: #008b8b;">this</span>.check_out, <span style="color: #a020f0;">function</span> () { <span style="color: #a020f0;">return</span> add_days(<span style="color: #008b8b;">this</span>.check_in(), <span style="color: #008b8b;">this</span>.nights()); })
      .method(<span style="color: #008b8b;">this</span>.check_in, <span style="color: #a020f0;">function</span> () { <span style="color: #a020f0;">return</span> remove_days(<span style="color: #008b8b;">this</span>.check_out(), <span style="color: #008b8b;">this</span>.nights()); })
      .method(<span style="color: #008b8b;">this</span>.nights, <span style="color: #a020f0;">function</span> () { <span style="color: #a020f0;">return</span> day_difference(<span style="color: #008b8b;">this</span>.check_in(), <span style="color: #008b8b;">this</span>.check_out()); });
  };

  <span style="color: #a020f0;">var</span> <span style="color: #daa520;">model</span> = hd.model(<span style="color: #a020f0;">new</span> <span style="color: #228b22;">DateModel</span>());

  $(document).ready(<span style="color: #a020f0;">function</span> () {
    hotdrink.bind(model);
  });
&lt;/script&gt;
</pre>


<p>
The model itself is a simple class consisting of only a constructor: the
<code>DateModel</code> function.  Inside the constructor, three variables are defined as
fields of the model using the <code>variable</code> API function.  The <code>variable</code>
function takes an optional parameter used to initialize the variable.  Here,
only two of the variables need to be initialized, since the value of the third
may be calculated using the constraint.
</p>
<p>
The constraint between the three variables is composed of three separate
methods, built up by chaining together calls to the <code>method</code> API function.
Each method is responsible for calculating the value of one variable using the
values of the other two.  The <code>method</code> function takes two parameters: the
variable it is calculating the value for, and a function that will return the
value for that variable.
</p>
<p>
Notice that the variables are actually proxy functions.  When the value of the
variable is required then the proxy function is called.  However, when
defining the output of a method, the proxy function itself must be passed
(without calling it).
</p>

</div>

</div>

<div id="outline-container-2-2" class="outline-3">
<h3 id="sec-2-2"><span class="section-number-3">2.2</span> View and bindings</h3>
<div class="outline-text-3" id="text-2-2">


<p>
The view is straightforward HTML code, with the three <code>input</code> elements
of type <code>text</code> and their associated labels. 
The style sheet code that aligns labels etc. is, for completeness, 
shown in FIXME.
</p>



<pre class="src src-javascript">&lt;fieldset&gt;
  &lt;legend&gt;Select dates&lt;/legend&gt;
  &lt;div&gt;
    &lt;label&gt;Check <span style="color: #a020f0;">in</span>&lt;/label&gt;
    &lt;input id=<span style="color: #a0522d;">"check_in"</span> type=<span style="color: #a0522d;">"text"</span> data-bind=<span style="color: #a0522d;">"text: {value: check_in, convert: stringToDate, convertBack: dateToString}"</span> /&gt;
  &lt;/div&gt;
  &lt;div&gt;
    &lt;label&gt;Check out&lt;/label&gt;
    &lt;input id=<span style="color: #a0522d;">"check_out"</span> type=<span style="color: #a0522d;">"text"</span> data-bind=<span style="color: #a0522d;">"text: {value: check_out, convert: stringToDate, convertBack: dateToString}"</span> /&gt;
  &lt;/div&gt;
  &lt;div&gt;
    &lt;label&gt;Nights&lt;/label&gt;
    &lt;input type=<span style="color: #a0522d;">"text"</span> data-bind=<span style="color: #a0522d;">"number: nights"</span> /&gt;
  &lt;/div&gt;
&lt;/fieldset&gt;
</pre>



<p>
Noteworthy are the <code>data-bind</code> attributes that specify the bindings between a
view.  For example, the <code>number: nights</code> binding specification in the last
text box effects a binding between that text box and the variable named
<code>nights</code> in the model.  Note that the <code>id</code> attribute is also given for the
<code>check_in</code> and <code>check_out</code> inputs, but Hotdrink does not depend on this
attribute &mdash; we chose to use jQuery.UI's <i>datepicker</i> with the <code>check_in</code> and
<code>check_out</code> fields, which necessitated defining the <code>id</code> attribute.
</p>
<p>
There are several options associated with each binding, depending on the
binding type used.  For most binding types, if you use the default values for
all options then only the variable being bound to must be specified.  This is
the case with the <code>nights</code> binding.  However, if you need to modify some
options then you must provide a more complex value for the binding: an object
containing the options as fields.  You can see this with the binding for
<code>check_in</code> and <code>check_out</code>.
</p>
<p>
One common option for bindings are data conversion functions.  These are
necessary when the value provided by the view is not the data type expected by
the model.  In our example, the <code>check_in</code> text field provides a date as a
string; however, our model requires a Javascript <code>Date</code> object.  This data
conversion is handled by functions which are passed using the <code>convert</code> and
<code>convertBack</code> options.  For completeness, the Javascript helper functions are
shown in FIXME.
</p>
</div>
</div>

</div>

<div id="outline-container-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Helper functions for manipulating dates</h2>
<div class="outline-text-2" id="text-3">


<p>
Here are the helper functions used in the model specification.
</p>



<pre class="src src-javascript">&lt;script type=<span style="color: #a0522d;">"text/javascript"</span>&gt;

<span style="color: #a020f0;">function</span> <span style="color: #0000ff;">dateToString</span> (<span style="color: #daa520;">d</span>) { <span style="color: #a020f0;">return</span> {value: $.datepicker.formatDate(<span style="color: #a0522d;">'mm/dd/yy'</span>, d)}; }
<span style="color: #a020f0;">function</span> <span style="color: #0000ff;">stringToDate</span> (<span style="color: #daa520;">s</span>) {
  <span style="color: #a020f0;">var</span> <span style="color: #daa520;">d</span>= Date.parse(s);
  <span style="color: #a020f0;">if</span> (isNaN(d))
    <span style="color: #a020f0;">return</span> {error: <span style="color: #a0522d;">"Invalid date format"</span>};
  <span style="color: #a020f0;">else</span>
    <span style="color: #a020f0;">return</span> {value: <span style="color: #a020f0;">new</span> <span style="color: #228b22;">Date</span>(d)};
}

<span style="color: #a020f0;">function</span> <span style="color: #0000ff;">add_days</span>(<span style="color: #daa520;">d</span>, <span style="color: #daa520;">n</span>) {
  <span style="color: #a020f0;">var</span> <span style="color: #daa520;">d2</span> = <span style="color: #a020f0;">new</span> <span style="color: #228b22;">Date</span>(d.getTime());
  d2.setDate(d.getDate() + n);
  <span style="color: #a020f0;">return</span> d2;
}

<span style="color: #a020f0;">function</span> <span style="color: #0000ff;">remove_days</span>(<span style="color: #daa520;">d</span>, <span style="color: #daa520;">n</span>) {
  <span style="color: #a020f0;">var</span> <span style="color: #daa520;">d2</span> = <span style="color: #a020f0;">new</span> <span style="color: #228b22;">Date</span>(d.getTime());
  d2.setDate(d.getDate() - n);
  <span style="color: #a020f0;">return</span> d2;
}

<span style="color: #ee0000; font-weight: bold;">// </span><span style="color: #ee0000; font-weight: bold;">1 day in milliseconds</span>
<span style="color: #a020f0;">var</span> <span style="color: #daa520;">one_day</span>=1000*60*60*24;

<span style="color: #a020f0;">function</span> <span style="color: #0000ff;">day_difference</span>(<span style="color: #daa520;">d1</span>, <span style="color: #daa520;">d2</span>) {
  <span style="color: #ee0000; font-weight: bold;">// </span><span style="color: #ee0000; font-weight: bold;">Calculate the difference in milliseconds</span>
  <span style="color: #a020f0;">var</span> <span style="color: #daa520;">difference_ms</span> = d2.getTime() - d1.getTime();

  <span style="color: #ee0000; font-weight: bold;">// </span><span style="color: #ee0000; font-weight: bold;">Convert back to days and return</span>
  <span style="color: #a020f0;">return</span> Math.round(difference_ms / one_day).toString(); 
}

<span style="color: #ee0000; font-weight: bold;">// </span><span style="color: #ee0000; font-weight: bold;">Associate datepicker with the check_in and check_out fiels,</span>
<span style="color: #ee0000; font-weight: bold;">// </span><span style="color: #ee0000; font-weight: bold;">and trigger a keyup event when a date is picked</span>
$(<span style="color: #a020f0;">function</span>() { 
  $( <span style="color: #a0522d;">"#check_in"</span> ).datepicker({
      <span style="color: #0000ff;">onSelect</span>: <span style="color: #a020f0;">function</span>() { $(<span style="color: #008b8b;">this</span>).keyup(); }
  });
  $( <span style="color: #a0522d;">"#check_out"</span> ).datepicker({
      <span style="color: #0000ff;">onSelect</span>: <span style="color: #a020f0;">function</span>() { $(<span style="color: #008b8b;">this</span>).keyup(); }
  });
});
&lt;/script&gt;
</pre>


</div>

</div>

<div id="outline-container-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> Dependencies</h2>
<div class="outline-text-2" id="text-4">


<p>
Currently these dependencies are needed to run the tutorial.
</p>



<pre class="src src-javascript">&lt;script type=<span style="color: #a0522d;">"text/javascript"</span> src=<span style="color: #a0522d;">"https://raw.github.com/kriskowal/es5-shim/master/es5-shim.min.js"</span>&gt;&lt;/script&gt;
&lt;script type=<span style="color: #a0522d;">"text/javascript"</span> src=<span style="color: #a0522d;">"http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"</span>&gt;&lt;/script&gt;
&lt;script type=<span style="color: #a0522d;">"text/javascript"</span> src=<span style="color: #a0522d;">"../../hotdrink.js"</span>&gt;&lt;/script&gt;
&lt;script src=<span style="color: #a0522d;">"http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"</span> type=<span style="color: #a0522d;">"text/javascript"</span>&gt;&lt;/script&gt;
&lt;script type=<span style="color: #a0522d;">"text/javascript"</span> src=<span style="color: #a0522d;">"http://code.jquery.com/ui/1.8.18/jquery-ui.min.js"</span>&gt;&lt;/script&gt;
&lt;link type=<span style="color: #a0522d;">"text/css"</span> href=<span style="color: #a0522d;">"http://code.jquery.com/ui/1.8.18/themes/base/jquery-ui.css"</span> rel=<span style="color: #a0522d;">"Stylesheet"</span> /&gt;
</pre>



</div>

</div>

<div id="outline-container-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> Tutorial style sheet</h2>
<div class="outline-text-2" id="text-5">





<pre class="src src-css"><span style="color: #0000ff;">fieldset </span>{
  <span style="color: #daa520;">padding</span>: 1em;
  <span style="color: #daa520;">font</span>:80%/1 sans-serif;
  }

<span style="color: #0000ff;">label </span>{
  <span style="color: #daa520;">float</span>:left;
  <span style="color: #daa520;">width</span>:25%;
  <span style="color: #daa520;">margin-right</span>:0.5em;
  <span style="color: #daa520;">padding-top</span>:0.2em;
  <span style="color: #daa520;">text-align</span>:right;
  <span style="color: #daa520;">font-weight</span>:bold;
  }

<span style="color: #0000ff;">fieldset </span>{ <span style="color: #daa520;">border</span>:1px solid blue }

<span style="color: #0000ff;">legend </span>{
  <span style="color: #daa520;">padding</span>: 0.2em 0.5em;
  <span style="color: #daa520;">border</span>:1px solid blue;
  <span style="color: #daa520;">color</span>:blue;
  <span style="color: #daa520;">font-size</span>:90%;
  <span style="color: #daa520;">text-align</span>:right;
  }
</pre>

</div>
</div>
</div>

<div id="postamble">
<p class="date">Date: 2012-05-04 16:52:15 </p>
<p class="author">Author: </p>
<a href="http://validator.w3.org/check?uri=referer">Validate XHTML 1.0</a>

</div>
</body>
</html>
